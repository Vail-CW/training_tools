# Vail Training Tools - Project Guide

## Project Overview

**Vail Training Tools** is a web-based Morse code training application designed to help amateur radio operators and Morse code enthusiasts practice receiving and sending Morse code. Currently in BETA, the application is deployed at https://training.vailmorse.com.

The project now includes four training modules:
1. **Copy Practice** - Basic Morse code receiving practice
2. **Send Practice** - Morse code sending practice with USB CW key support
3. **Free Practice** - Freeform morse sending with real-time decoding and MP3 recording
4. **QSO Simulator** - Advanced pileup training for contesting and field operations

**Status:** BETA - All modules functional with USB CW key support and MP3 recording
**Contact:** ke9bos@pigletradio.org
**Community:** https://discord.gg/GBzj8cBat7

## Technology Stack

### Main Training Tools (Copy/Send Practice)
- **Pure HTML5/CSS3/JavaScript (ES6+)** - No frameworks or build tools
- **Bulma CSS Framework (v0.9.3)** - For responsive layout and components
- **Material Design Icons (v6.5.95)** - Icon library
- **Web Audio API** - For precise Morse code tone generation
- **No build process** - Static files deployable anywhere

### QSO Simulator Module
- **HTML5/CSS3/JavaScript (ES6+)** with Webpack build system
- **Bootstrap 5** with Bootswatch Darkly theme + custom Vail colors
- **FontAwesome Icons (v6.7.1)** - Icon library
- **Web Audio API** - For complex multi-tone generation with QSB/QRN effects
- **Webpack** - Module bundler and build tool
- **npm** - Package management

### Architecture
- **Event-driven architecture** with state-based UI management
- **Web Audio API** for accurate timing and tone generation
- **Hybrid approach:** Main training tools are pure static; QSO Simulator uses modern build pipeline

## Project Structure

```
Vail Training Tools/
├── .claude/                     # Claude configuration
│   └── settings.local.json
├── training/                    # Main application directory
│   ├── assets/                  # Reserved for future assets (currently empty)
│   ├── qso-simulator/           # QSO Simulator module (formerly Morse Walker)
│   │   ├── src/                 # Source files
│   │   │   ├── js/              # JavaScript modules
│   │   │   │   ├── app.js       # Main application entry point
│   │   │   │   ├── audio.js     # Audio engine with QSB/QRN effects
│   │   │   │   ├── inputs.js    # Input validation and handling
│   │   │   │   ├── modes.js     # Training mode configurations
│   │   │   │   ├── stationGenerator.js  # Station generation logic
│   │   │   │   ├── util.js      # Utility functions
│   │   │   │   └── morse-input/ # USB CW key support (NEW)
│   │   │   │       ├── keyer.js    # Multi-mode keyer logic (256 lines)
│   │   │   │       ├── decoder.js  # Dit/dah to character (148 lines)
│   │   │   │       ├── sounder.js  # Audio sidetone (112 lines)
│   │   │   │       └── morse-input.js  # System coordinator (113 lines)
│   │   │   ├── css/
│   │   │   │   └── style.css    # Custom Vail dark theme overrides
│   │   │   ├── audio/           # Audio assets (static noise)
│   │   │   ├── img/             # Images and icons
│   │   │   ├── index.html       # Main QSO Simulator page
│   │   │   └── 404.html         # Error page
│   │   ├── dist/                # Built/compiled files (generated by webpack)
│   │   ├── node_modules/        # npm dependencies
│   │   ├── package.json         # Node.js dependencies and scripts
│   │   ├── webpack.config.*.js  # Webpack build configurations
│   │   └── jsdoc.json           # JSDoc configuration
│   ├── lib/                      # External libraries
│   │   └── lame.min.js           # lamejs MP3 encoder for Free Practice recording
│   ├── scripts/
│   │   ├── training.js           # Core Copy/Send/Free practice logic (1683 lines)
│   │   ├── morse-sounder.js      # Sidetone audio generator for send practice
│   │   ├── morse-decoder.js      # Dit/dah pattern decoder with adaptive timing
│   │   ├── morse-keyer.js        # Keyboard/USB key handler with iambic modes
│   │   ├── morse-input-handler.js # MIDI + keyboard input manager
│   │   ├── morse-pro-adapter.js  # Enhanced decoder for Free Practice with prosigns
│   │   └── audio-recorder.js     # MP3 recording engine for Free Practice
│   ├── index.html                # Main landing page with module switcher
│   └── training.css              # Dark theme styles for main tools (722 lines)
├── netlify-deploy/              # Production deployment package
│   ├── index.html               # Main landing page
│   ├── training.css             # Site styles
│   ├── assets/                  # Shared resources
│   ├── scripts/                 # Shared JavaScript
│   └── qso-simulator/           # Built QSO Simulator with USB CW support
└── .claude.md                   # This file
```

## Key Files

### [training/index.html](training/index.html)
- Main application page with semantic HTML5 structure
- Three practice modules: Copy Practice, Send Practice, and QSO Simulator
- **Copy Practice modes:** All Letters, All Numbers, Letters & Numbers, Custom Selection, Common Words, Callsigns, Q Codes
- **Send Practice modes:** Random Letters, Random Numbers, Letters & Numbers, Common Words
- **Keyer modes:** Straight Key, Iambic A, Iambic B, Ultimatic
- Settings controls for volume, tone frequency, and reset
- Statistics panel for tracking performance
- Bulma CSS components for responsive layout

### [training/scripts/training.js](training/scripts/training.js)
- **Audio System:** Web Audio API implementation with precise timing
- **Morse Code Data:** Complete morse code mappings, word lists, callsign generator, Q codes
- **Copy Practice Logic:** Random generation, answer checking, statistics tracking
- **Send Practice Logic:** Target character generation, morse input integration, auto-advance on correct send
- **Timing Standard:** PARIS timing (50 dit units per minute at 1 WPM)
  - Dit duration = 1200 / WPM milliseconds
  - Dah duration = 3 × dit

### [training/scripts/morse-sounder.js](training/scripts/morse-sounder.js)
- **Sidetone Audio Generator** for send practice
- Web Audio API oscillator with envelope shaping (5ms attack/release)
- Volume control integration with global settings
- Prevents audio clicks with proper gain ramping
- Manages oscillator lifecycle (on/off states)

### [training/scripts/morse-decoder.js](training/scripts/morse-decoder.js)
- **Dit/Dah Pattern Decoder** converts morse sequences to characters
- **Adaptive Timing:** Automatically adjusts to user's sending speed
- Complete morse alphabet mapping (letters, numbers, punctuation)
- Farnsworth spacing support for letter recognition
- Character-level decoding with callback notification
- Returns '*' for unrecognized sequences

### [training/scripts/morse-keyer.js](training/scripts/morse-keyer.js)
- **Multi-mode Keyer Handler** processes key events and generates dit/dah patterns
- **4 Keyer Modes:**
  - Straight Key (mode 1) - Direct key-down/key-up
  - Iambic A (mode 2) - Basic squeeze keying with queue clearing
  - Iambic B (mode 3) - Advanced squeeze keying with alternation
  - Ultimatic (mode 4) - Last-pressed-key priority
- Integrates with sounder (audio) and decoder (character recognition)
- High-frequency oscillator timer for responsive keying
- PARIS method WPM calculation (60000 / (wpm * 50) = dit duration in ms)
  - Element gap = 1 × dit (between dits/dahs within letter)
  - Letter gap = 3 × dit (between letters)
  - Word gap = 7 × dit (between words)
- **Audio Engineering:** 5ms attack/release envelope to prevent clicks

### [training/scripts/morse-input-handler.js](training/scripts/morse-input-handler.js)
- **Unified Input Manager** for both MIDI and keyboard CW keys
- **MIDI Support:**
  - Web MIDI API integration for direct device connection
  - Auto-detects and connects to MIDI CW keys
  - Supports Vail Adapter protocol (MIDI notes 0, 1, 2 for straight/dit/dah)
  - Supports N6ARA TinyMIDI protocol (MIDI notes 20, 21 for dit/dah)
  - Hot-plug support with automatic reconnection
  - Sends configuration to adapter (dit duration via CC 0x01, keyer mode via Program Change)
  - Releases all keys on device disconnect
- **Keyboard Support:**
  - Key Mappings (compatible with vband USB adapter):
    - Dit: Left Ctrl or `[` key
    - Dah: Right Ctrl or `]` key
  - Prevents default browser behavior for CW keys
- **Practice-Aware:** Only processes input when Send Practice module is active
- **Integration:** Creates synthetic keyboard events to interface with existing keyer logic
- Based on Vail Repeater MIDI implementation

### [training/training.css](training/training.css)
- Custom dark theme optimized for extended practice sessions
- Color palette: #0a0a0a (background), #1a1a1a (boxes), #00d1b2 (accent)
- Smooth animations and transitions (0.2-0.3s ease)
- Responsive breakpoints at 768px for mobile
- Component-based styling approach

## Core Features

### Copy Practice (Implemented)
1. **Practice Modes:**
   - All Letters (A-Z)
   - All Numbers (0-9)
   - Letters & Numbers
   - Custom Selection (pick specific characters)
   - Common Words (100+ words including ham radio terms)
   - Callsigns (realistic US amateur radio callsigns)
   - Q Codes (20 common amateur radio Q codes)
   - CW Academy (10 beginner sessions with progressive character introduction and prosigns)

2. **Settings:**
   - Speed: 5-40 WPM (default 12 WPM)
   - Volume: 0-100%
   - Tone Frequency: 400-1000 Hz (default 600 Hz)
   - Character Count: 1-10 characters per sequence (default 1)
     - Available for: Letters, Numbers, Mixed, Custom, CW Academy modes
     - Hidden for: Words, Callsigns, Q Codes modes

3. **CW Academy Integration:**
   - 10 progressive sessions following CW Academy Beginner curriculum
   - Session 1: A, E, N, T
   - Session 2: + S, I, O and numbers 1, 4
   - Session 3: + H, D, L, R and numbers 2, 5
   - Session 4: + C, U
   - Session 5: + M, W and numbers 3, 6
   - Session 6: + F, Y
   - Session 7: + G, P, Q and numbers 7, 9
   - Session 8: + B, V and prosign AR
   - Session 9: + J, K and prosigns BT + number 0
   - Session 10: + X, Z and prosigns BK, SK + number 8
   - Prosigns have 20% chance of appearing (when available)
   - Character count setting applies to regular characters
   - Prosigns always appear as single units

4. **User Experience Features:**
   - **Auto-capitalization:** All input automatically converts to uppercase
   - **Smart wrong answer handling:**
     - Shows "Try again..." message for 1 second
     - Automatically replays morse code after 1 second
     - "Show Answer" button appears to reveal answer if needed
     - Typing a new guess re-enables "Check Answer" button
   - **Manual answer reveal:**
     - Click "Show Answer" to see correct answer
     - "Continue" button appears (must click to proceed to next)
     - Gives full control over pacing
   - **Correct answer flow:**
     - Shows "Correct!" message with answer
     - Automatically advances to next question after 2 seconds

5. **Session Statistics:**
   - Total attempts
   - Correct answers
   - Accuracy percentage
   - Current speed display

6. **Prosign Support:**
   - AR (end of message): ·-·-·
   - BT (break/pause): -···-
   - BK (break-in): -···-·-
   - SK (end of contact): ···-·-
   - Properly handled as single units in morse playback

### Send Practice (Implemented)
A dedicated module for practicing sending Morse code with real-time feedback. Supports both MIDI CW keys (Vail adapter) and keyboard mode (vband adapter), providing a focused environment for developing clean, accurate sending skills.

**Practice Modes:**
1. **Random Letters** - Single random letters (A-Z)
2. **Random Numbers** - Single random digits (0-9)
3. **Letters & Numbers** - Mixed alphanumeric characters
4. **Common Words** - Practice sending complete words from the ham radio word list

**Keyer Modes:**
- **Straight Key (mode 1)** - Direct key-down/key-up control
- **Iambic A (mode 2)** - Basic squeeze keying with queue clearing (default)
- **Iambic B (mode 3)** - Advanced squeeze keying with dit/dah alternation
- **Ultimatic (mode 4)** - Last-pressed-key priority mode

**Input Methods:**

*MIDI Mode (Vail Adapter):*
- Supports Web MIDI API for direct connection to Vail MIDI adapter
- Automatically detects and connects to MIDI devices
- Supports Vail Adapter protocol (notes 0, 1, 2)
- Supports N6ARA TinyMIDI protocol (notes 20, 21)
- Sends configuration to adapter (dit duration, keyer mode)
- Hot-plug support (auto-reconnects when device is plugged in)

*Keyboard Mode (vband Adapter):*
- **Dit:** Left Ctrl or `[` key
- **Dah:** Right Ctrl or `]` key
- Compatible with vband USB CW key adapter (https://www.vailadapter.com)
- No additional drivers needed

**How It Works:**
1. Press "Start Practice" to begin
2. A target character appears in large text (8rem font size)
3. Send the character using your USB key or keyboard
4. System decodes your morse input with adaptive timing
5. When correct character is sent, automatically advances to next target
6. Visual feedback via send lamp indicator (glows on character decode)

**Features:**
- **Adaptive Timing:** Decoder automatically adjusts to your sending speed
- **Auto-advance:** Generates new target immediately after correct send
- **Real-time Feedback:** "What You Sent" field shows decoded characters
- **Sidetone Audio:** Configurable tone frequency (uses global settings)
- **Visual Indicators:** Send lamp flashes when characters are decoded
- **Manual Skip:** "Next Character" button to skip difficult targets

**Technical Implementation:**
- **Unified Input Handler:** `morse-input-handler.js` manages both MIDI and keyboard inputs
- **Web MIDI API:** Direct browser support for MIDI devices (no drivers needed)
- **Adaptive Input:** Automatically uses MIDI if available, falls back to keyboard
- **Practice-aware:** Only processes input when Send Practice is active
- Standalone morse input modules (no ES6 modules, direct script includes)
- Shared Web Audio API context with copy practice
- Character-level decoding with callback notification
- High-frequency oscillator timer for responsive keying
- 5ms attack/release envelope for click-free sidetone
- **MIDI Configuration:** Automatically sends dit duration and keyer mode to MIDI adapter

### Free Practice (Implemented)
A freeform morse code sending module that provides complete freedom to practice without targets or constraints. Features real-time adaptive decoding with prosign support and the ability to record practice sessions as MP3 files. **Always active** - begins decoding immediately when the page loads, no "Start Practice" button required.

**Core Features:**
- **Always Active:** Decoding starts automatically on page load, ready to capture morse input immediately
- **Freeform Sending:** Practice sending morse code freely without predefined targets
- **Real-time Decoding:** Enhanced adaptive decoder displays your sending in real-time
- **Prosign Detection:** Automatically recognizes and displays prosigns (<AR>, <BT>, <SK>, <BK>, etc.)
- **Statistics Tracking:** Live character count, word count, and speed (WPM) indicators
- **MP3 Recording:** Record up to 10 minutes of practice and export as MP3
- **Auto-Configuration:** Changing WPM or keyer mode automatically sends MIDI commands to connected devices

**Input Methods:**
- **MIDI Mode (Vail Adapter):**
  - Auto-detected MIDI CW keys (Vail adapter, TinyMIDI protocol)
  - Hot-plug support with automatic device reconnection
  - Automatic configuration sync (dit duration, keyer mode)
- **Keyboard Mode (vband Adapter):**
  - Left/Right Ctrl (dit/dah) or `[`/`]` keys
  - Compatible with vband USB CW key adapter
  - No additional drivers needed

**Keyer Modes:**
- **Straight Key (mode 1)** - Direct key-down/key-up control
- **Iambic A (mode 2)** - Basic squeeze keying (default)
- **Iambic B (mode 3)** - Advanced squeeze keying with alternation
- **Ultimatic (mode 4)** - Last-pressed-key priority mode

**Recording Features:**
- **Start/Stop Recording:** Capture sidetone audio during practice
- **Playback Preview:** Listen to your recording before saving
- **MP3 Export:** Download recording as MP3 file
- **10-Minute Limit:** Prevents memory issues (warning at 9:30)
- **Filename Format:** `vail-practice-YYYYMMDD-HHMMSS.mp3`
- **Encoding:** 128kbps, 44.1kHz, stereo MP3 using lamejs

**Output Display:**
- Large scrolling textarea with monospace font
- Auto-scroll to bottom as characters are decoded
- Character counter (e.g., "152 chars")
- Word counter (e.g., "28 words")
- Real-time WPM speed indicator
- Copy to clipboard button
- Clear output button

**Technical Implementation:**
- **Always-Active Architecture:**
  - All components initialized immediately on page load in `initFreePractice()`
  - Dedicated `MorseInputHandler` with `() => true` callback (always active)
  - No Start/Stop buttons - keyer runs continuously
  - MIDI configuration updates sent when settings change
- **MorseProAdapter:** Enhanced decoder with prosign support and adaptive timing
  - Extends existing morse decoder with 40+ morse mappings including prosigns
  - Adaptive dit/dah duration learning (30-sample rolling average)
  - Automatic character/word gap detection (3 dit / 7 dit units)
  - WPM calculation using PARIS standard (50 dit units)
- **AudioRecorder:** MP3 recording engine using Web Audio API + lamejs
  - ScriptProcessorNode captures PCM audio from sidetone
  - Buffers Float32 samples during recording (4096 sample chunks)
  - Encodes to MP3 on stop using lamejs encoder
  - Creates downloadable Blob with automatic filename generation
- **Integration:** Reuses existing MorseKeyer, MorseSounder, and MorseInputHandler
- **Settings Persistence:** WPM and keyer mode saved to localStorage

**Prosign Support:**
- AR (end of message): `·-·-·` → `<AR>`
- BT (break/pause): `-···-` → `<BT>`
- SK (end of contact): `···-·-` → `<SK>`
- BK (break-in): `-···-·-` → `<BK>`
- Plus additional prosigns: SN, AA, AS, CT, HH, SOS
- Prosigns displayed with brackets to distinguish from regular characters

**File Locations:**
- Main logic: [training/scripts/training.js:1198-1682](training/scripts/training.js#L1198-L1682)
- Enhanced decoder: [training/scripts/morse-pro-adapter.js](training/scripts/morse-pro-adapter.js)
- MP3 recorder: [training/scripts/audio-recorder.js](training/scripts/audio-recorder.js)
- CSS styles: [training/training.css:620-721](training/training.css#L620-L721)
- HTML structure: [training/index.html:463-654](training/index.html#L463-L654)

### QSO Simulator (Implemented)
A sophisticated pileup training simulator for practicing contest-style and field activation QSOs. Based on the Morse Walker project by W6NYC, heavily customized with Vail branding and color scheme.

**Training Modes:**
1. **Single Caller** - Practice basic QSOs with one station at a time
2. **Basic Contest** - Handle multiple stations calling simultaneously
3. **POTA Activator** - Simulate Parks on the Air activation scenarios
4. **CW Ops Test (CWT)** - Practice CWT-style exchanges
5. **K1USN SST** - Simulate SST contest format

**USB CW Key Support (NEW - Added November 2025):**
- **Real-time Morse Input:** Use keyboard or USB CW keys to send morse code
- **Key Mappings:**
  - **Left Control** = Dit (primary)
  - **Right Control** = Dah (primary)
  - **`[` key** = Dit (backup for USB interfaces like vband)
  - **`]` key** = Dah (backup for USB interfaces)
- **Multiple Keyer Modes:**
  - **Mode 1: Straight Key** - Direct on/off control
  - **Mode 2: Iambic A** - Automatic alternation between dit and dah
  - **Mode 3: Iambic B** - Enhanced with queue retention for smoother keying
  - **Mode 4: Ultimatic** - Lever-priority keying mode
- **Real-time Decoder:**
  - Automatically converts dit/dah timing into characters
  - Adaptive speed adjustment based on your actual keying speed
  - Inserts decoded characters directly into input fields
  - Supports Farnsworth timing configuration
- **Audio Sidetone:**
  - Configurable sidetone frequency (matches "Your Sidetone" setting)
  - Configurable volume (matches "Sidetone Volume" setting)
  - 5ms attack/release envelope for smooth, click-free tones
  - Uses shared AudioContext with main application
- **Morse Input Modules:**
  - `keyer.js` - Multi-mode keyer implementation with WPM-based timing
  - `decoder.js` - Dit/dah sequence to character conversion with adaptive timing
  - `sounder.js` - Audio sidetone generation using Web Audio API
  - `morse-input.js` - System coordinator and MorseWalker integration
- **Integration:**
  - Initializes automatically when CQ button is clicked
  - Syncs with user settings (WPM, sidetone frequency, Farnsworth spacing)
  - LocalStorage persistence for keyer mode preference
  - Non-intrusive - doesn't interfere with existing typed input method

**Key Features:**
- **Realistic Audio Environment:**
  - Multiple simultaneous CW tones at different frequencies
  - QSB (signal fading) simulation with configurable percentage
  - QRN (atmospheric noise) at various intensity levels (Off, Normal, Moderate, Heavy)
  - Volume normalization prevents audio artifacts

- **Configurable Settings:**
  - Your station: Callsign, name, state, speed (WPM), sidetone frequency/volume, keyer mode
  - Responding stations: Max stations, speed range (min/max WPM), Farnsworth spacing
  - Tone range: 400-9999 Hz (min/max)
  - Volume range: 0-100% (min/max)
  - Wait time: 0-5 seconds between responses
  - Cut numbers support (T/0, A/1, U/2, V/3, E/5, G/7, D/8, N/9) - PRESERVED
  - Callsign format options (1x1, 1x2, 2x1, 2x2, 1x3, 2x3)
  - US-only callsigns option

- **Advanced Interactions:**
  - Partial callsign matching to isolate stations in pileup
  - "AGN" or "?" to request repeats
  - "QRS" to slow down responding stations (adds Farnsworth spacing)
  - Real-time attempts and timing tracking
  - Results table with accuracy feedback
  - USB CW key input for realistic sending practice

- **Development Tools:**
  - Browser console "cheat mode" displays calling station callsigns
  - JSDoc documentation available
  - Webpack build system for optimization
  - Hot module replacement in dev mode
  - Prettier code formatting
  - Husky pre-commit hooks

**Technical Architecture:**
- Modular ES6+ JavaScript with Webpack bundling
- Shared AudioContext with individual OscillatorNode instances per station
- GainNode for QSB simulation with depth, frequency, and phase randomization
- Mode-based configuration system for different contest formats
- LocalStorage for settings persistence
- Bootstrap 5 + custom Vail dark theme CSS
- Morse input system with event-driven keyer/decoder architecture

**File Locations:**
- Main source: [training/qso-simulator/src/](training/qso-simulator/src/)
- Morse input: [training/qso-simulator/src/js/morse-input/](training/qso-simulator/src/js/morse-input/)
- Build output: [training/qso-simulator/dist/](training/qso-simulator/dist/)
- Entry point: [training/qso-simulator/src/js/app.js](training/qso-simulator/src/js/app.js)
- Theme customization: [training/qso-simulator/src/css/style.css](training/qso-simulator/src/css/style.css)

**Build Commands:**
```bash
cd training/qso-simulator
npm install          # Install dependencies
npm start           # Development server with hot reload
npm run build       # Production build to dist/
npm run format      # Format code with Prettier
```

**Vail Customizations:**
- Rebranded from "Morse Walker" to "Vail QSO Simulator"
- Changed tagline from "Walk before you run!" to "Master the pileup!"
- Applied Vail dark theme colors (turquoise #00d1b2 accent on dark backgrounds)
- Updated all links to point to vailmorse.com, Discord, and KE9BOS contact
- Maintained credit to original author W6NYC in footer
- Switched from Cerulean to Darkly Bootstrap theme with CSS overrides
- Added USB CW key support while preserving all original features (especially cut numbers)

## Development Guidelines

### Code Style & Conventions
- **JavaScript:** camelCase for variables/functions, descriptive names
- **Constants:** Organized in object literals (morseCode, commonWords, etc.)
- **Event Handling:** Event-driven with DOMContentLoaded initialization
- **State Management:** Simple object-based state tracking
- **Error Handling:** Console logging for debugging, try-catch for critical operations

### Naming Patterns
- Functions: `playTone()`, `generateCallsign()`, `checkAnswer()`
- State variables: `isPracticing`, `currentAnswer`, `isPlaying`
- UI elements: descriptive IDs matching their purpose (e.g., `copyModeSelect`, `checkAnswerBtn`)

### CSS Architecture
- Component-based class naming: `.practice-box`, `.stats-box`, `.settings-dropdown`
- Dark theme first with consistent color variables
- Smooth transitions and animations throughout
- Mobile-first responsive design

### Audio Implementation Details
- **Click Prevention:** 5ms attack/release envelope on all tones
- **Volume Safety:** Max gain clamped to 0.3 (30%) to prevent clipping
- **Precise Timing:** Web Audio API currentTime for scheduling accuracy
- **State Guards:** isPlaying flag prevents audio overlap
- **Shared Context:** All audio components use a single AudioContext for efficiency

### Amateur Radio Realism
- **Callsign Generator:**
  - 70% single-letter prefix (W, K, N, A)
  - 30% two-letter prefix (AA-AL, KA-KZ, NA-NZ, WA-WZ)
  - Weighted suffix lengths: 20% one letter, 40% two letters, 40% three letters
- **Q Codes:** 20 most common codes (QRL, QRM, QRN, QRO, QRP, QRS, QRT, QRZ, QSB, QSL, QSO, QSY, QTH, QRQ, QRV, QRX, QRK, QSK, QTC, QRU)
- **Common Words:** Mix of general English and ham radio terminology

## Development Workflow

### Local Development - Main Training Tools
1. Open [training/index.html](training/index.html) in a modern web browser
2. Make changes to HTML, CSS, or JS files
3. Refresh browser to see changes (no build step required)
4. Use browser DevTools console for debugging (extensive console.log statements in code)

### Local Development - QSO Simulator
1. Navigate to qso-simulator directory: `cd training/qso-simulator`
2. Install dependencies (first time only): `npm install`
3. Start development server: `npm start` (opens browser automatically at http://localhost:8080)
4. Make changes to files in `src/` directory
5. Webpack dev server auto-reloads on file changes
6. Build for production: `npm run build` (outputs to `dist/` directory)

### Testing Approach
- **Manual testing** in browser (no automated tests currently)
- Test across different browsers (Chrome, Firefox, Safari, Edge)
- Verify audio playback and timing accuracy
- Test responsive design at various screen sizes
- Verify all practice modes generate appropriate content
- **QSO Simulator:** Test multiple simultaneous audio streams and QSB/QRN effects
- **USB CW Key Testing:**
  - Test Left/Right Control keys for dit/dah input
  - Test bracket keys `[` and `]` as backup inputs
  - Verify all 4 keyer modes (straight, iambic A, iambic B, ultimatic)
  - Test decoder accuracy at various speeds (5-40 WPM)
  - Verify sidetone audio and volume control
  - Test Farnsworth timing integration

### Deployment
- **Deployment Package Location:** `netlify-deploy/` folder in project root
- **Build Process:**
  1. Navigate to qso-simulator: `cd training/qso-simulator`
  2. Run production build: `npm run build`
  3. Update netlify-deploy folder: Handled automatically by build process
- **Deployment Steps:**
  1. Drag entire `netlify-deploy/` folder to Netlify dashboard
  2. Or use CLI: `netlify deploy --prod --dir=netlify-deploy`
- **Currently deployed at:** https://training.vailmorse.com
- **What's Included:**
  - Main landing page and training tools (static files)
  - QSO Simulator with USB CW key support (built and bundled)
  - All assets, images, and resources

## Technical Highlights

### Web Audio API Implementation
```javascript
// Initialize audio context
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// Create oscillator and gain nodes
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();

// Precise timing using scheduled automation
gainNode.gain.setValueAtTime(0, startTime);
gainNode.gain.linearRampToValueAtTime(volume, startTime + attackTime);
gainNode.gain.setValueAtTime(volume, endTime - releaseTime);
gainNode.gain.linearRampToValueAtTime(0, endTime);
```

### PARIS Timing Standard
The application uses the PARIS standard for Morse code timing:
- 1 WPM = 50 dit units per minute (word "PARIS" = 50 dits)
- At 1 WPM, one dit = 1.2 seconds (1200 milliseconds)
- At N WPM, one dit = 1200 / N milliseconds

### USB CW Key Architecture
```javascript
// Keyer captures keyboard events
document.addEventListener('keydown', (event) => {
  keyer.press(event, true);  // Key down
});

document.addEventListener('keyup', (event) => {
  keyer.press(event, false); // Key up
});

// Decoder measures timing and converts to characters
decoder.keyOn();  // Start timing
decoder.keyOff(); // Calculate dit/dah and decode

// Sounder provides audio feedback
sounder.on();  // Smooth attack
sounder.off(); // Smooth release
```

### State Management Pattern
```javascript
const state = {
    isPracticing: false,
    currentAnswer: '',
    stats: { total: 0, correct: 0 }
};

// UI reflects state through enable/disable patterns
function updateUI() {
    startBtn.disabled = isPracticing;
    stopBtn.disabled = !isPracticing;
    checkAnswerBtn.disabled = !isPracticing;
}
```

## Known Limitations & Future Work

### Current Limitations
- No settings persistence for main training tools (localStorage not implemented)
- No progress tracking over time
- No automated testing
- Limited accessibility features
- Magic numbers throughout code (could be constants)
- No error handling for audio context initialization failures

### Planned Features (TODOs)
1. **Send Practice Module** ([training/scripts/training.js:558](training/scripts/training.js#L558), [training/scripts/training.js:563](training/scripts/training.js#L563))
   - Key down/up visual feedback
   - Keyboard shortcuts implementation (`.`, `/`, `x`, `z` keys)
   - CW key adapter support
   - Timing analysis and feedback

2. **Settings Persistence**
   - Save user preferences to localStorage
   - Restore settings on page load

3. **Progress Tracking**
   - Track performance over multiple sessions
   - Show improvement trends
   - Export practice logs

4. **Enhanced Accessibility**
   - More ARIA labels
   - Keyboard navigation improvements
   - Screen reader optimization

## External Resources

### CDN Dependencies
- Bulma CSS v0.9.3: https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css
- Material Design Icons v6.5.95: https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css

### Related Links
- Main Vail Morse Repeater: http://vailmorse.com
- CW Adapter Product: https://www.vailadapter.com
- Discord Community: https://discord.gg/GBzj8cBat7

## Common Tasks

### Adding a New Practice Mode
1. Add mode to [training/index.html](training/index.html) `copyModeSelect` dropdown
2. Implement generation logic in [training/scripts/training.js](training/scripts/training.js) `startCopyPractice()` function
3. Test with various WPM settings

### Adjusting Timing Parameters
Edit constants in [training/scripts/training.js](training/scripts/training.js) `getTimingFromWPM()` function:
- `ditTime`: Base unit for all timing (1200 / wpm)
- `dahTime`: 3× dit time
- `elementGap`: 1× dit time (between dits/dahs)
- `letterGap`: 3× dit time (between letters)
- `wordGap`: 7× dit time (between words)

### Modifying Color Scheme
Edit CSS custom properties in [training/training.css](training/training.css):
- Background: `#0a0a0a`
- Box background: `#1a1a1a`
- Text: `#e8e8e8`
- Accent: `#00d1b2` (Bulma turquoise)
- Borders: `#2a2a2a`

### Adding New Words or Q Codes
Edit arrays in [training/scripts/training.js](training/scripts/training.js):
- `commonWords`: Array of practice words (line ~30-130)
- `qCodes`: Array of Q code objects with code and description (line ~135-160)

### Modifying USB CW Key Mappings
Edit keyer initialization in [training/qso-simulator/src/js/morse-input/keyer.js](training/qso-simulator/src/js/morse-input/keyer.js):
- `ditKey1`: Primary dit key (currently 'ControlLeft')
- `dahKey1`: Primary dah key (currently 'ControlRight')
- `ditKey2`: Backup dit key (currently 'BracketLeft')
- `dahKey2`: Backup dah key (currently 'BracketRight')

## Debugging Tips

### Audio Issues
1. Check browser console for Web Audio API errors
2. Verify `audioContext.state === 'running'`
3. Test with different tone frequencies (400-1000 Hz range)
4. Check volume is not set to 0

### Timing Issues
1. Console logs show timing calculations in `playMorseSequence()`
2. Verify WPM setting is within 5-40 range
3. Check that `getTimingFromWPM()` returns expected values

### USB CW Key Issues
1. Check browser console for keyboard event logging
2. Verify keyer mode is set correctly (1-4)
3. Test with both Control keys and bracket keys
4. Check sidetone volume is not set to 0
5. Ensure morse input is initialized (click CQ button first)
6. Verify decoder timing thresholds match expected WPM

### UI State Issues
1. Check `isPracticing` flag state
2. Verify event listeners are properly attached
3. Use browser DevTools to inspect button disabled states

## Best Practices

### When Modifying Code
- Maintain consistent indentation (2 spaces)
- Add console.log statements for debugging
- Test audio timing with metronome/reference
- Verify mobile responsiveness after UI changes
- Keep dark theme consistent across new components

### When Adding Features
- Follow existing event-driven patterns
- Use descriptive variable and function names
- Add comments for complex timing or audio logic
- Test across multiple browsers
- Consider mobile users (touch interactions, screen size)

### Code Organization
- Keep related functionality grouped together
- Separate concerns: audio, UI, practice logic
- Use small, focused functions
- Avoid global variables where possible
- Document any non-obvious algorithms

## Contributing Guidelines

### Code Quality
- Write clean, readable code with consistent formatting
- Add comments for complex logic
- Use meaningful variable names
- Keep functions focused and small
- Test thoroughly before committing

### Amateur Radio Standards
- Maintain PARIS timing standard accuracy
- Use realistic callsign patterns
- Include appropriate Q codes and abbreviations
- Follow amateur radio conventions

### User Experience
- Maintain dark theme for eye comfort
- Keep UI simple and uncluttered
- Provide immediate feedback for user actions
- Ensure responsive design works on mobile
- Consider accessibility in all UI changes

---

## Quick Reference

### Key Functions
- `initAudioContext()`: Initialize Web Audio API
- `playTone(frequency, duration, volume)`: Generate sine wave tone
- `playMorseSequence(text, wpm, frequency, volume)`: Play complete Morse sequence
- `getTimingFromWPM(wpm)`: Calculate timing values from WPM
- `generateCallsign()`: Create realistic amateur radio callsign
- `checkAnswer()`: Validate user input and update statistics

### Important Constants
- Default WPM: 20
- Default Tone: 600 Hz
- Default Volume: 50%
- WPM Range: 5-40
- Tone Range: 400-1000 Hz

### File Locations
- Main HTML: [training/index.html](training/index.html)
- Core Logic: [training/scripts/training.js](training/scripts/training.js)
- Styles: [training/training.css](training/training.css)
- Send Practice Modules:
  - [training/scripts/morse-sounder.js](training/scripts/morse-sounder.js) - Audio sidetone
  - [training/scripts/morse-decoder.js](training/scripts/morse-decoder.js) - Dit/dah to character
  - [training/scripts/morse-keyer.js](training/scripts/morse-keyer.js) - Keyer logic
  - [training/scripts/morse-input-handler.js](training/scripts/morse-input-handler.js) - MIDI + keyboard input
- QSO Simulator: [training/qso-simulator/](training/qso-simulator/)
- QSO Simulator USB Modules: [training/qso-simulator/src/js/morse-input/](training/qso-simulator/src/js/morse-input/)
- Deployment Package: [netlify-deploy/](netlify-deploy/)

---

## Recent Updates

### November 23, 2025 - Free Practice Always-Active Architecture
- **Restructured Free Practice to be always active** - no Start/Stop buttons required
- **Auto-initialization:** All components (adapter, sounder, keyer, input handler) initialize on page load
- **Always-ready decoding:** Dedicated `MorseInputHandler` with `() => true` callback
- **MIDI Auto-configuration:** WPM and keyer mode changes automatically sent to connected MIDI devices
- **UI Simplification:**
  - Removed Start Practice and Stop Practice buttons
  - Enabled Clear Output, Copy Text, and Start Recording buttons by default
  - Updated placeholder text to reflect always-active state
- **Technical Changes:**
  - `initFreePractice()` now initializes all components immediately
  - WPM slider calls `setDitDuration()` on MIDI input handler
  - Keyer mode selector calls `setKeyerMode()` on MIDI input handler
  - Removed unused `startFreePractice()` and `stopFreePractice()` functions
- Updated documentation to reflect always-active architecture

### November 23, 2025 - Free Practice Module Implementation
- **Implemented complete Free Practice module** with real-time decoding and MP3 recording
- Created 2 new core modules for Free Practice:
  - `morse-pro-adapter.js` - Enhanced adaptive decoder with prosign support (275 lines)
  - `audio-recorder.js` - MP3 recording engine using lamejs (285 lines)
- **Core Features:**
  - Freeform morse sending without constraints or targets
  - Real-time adaptive decoding with character/word recognition
  - Live statistics: character count, word count, WPM speed
  - Prosign detection and display (AR, BT, SK, BK, SN, AA, AS, CT, HH, SOS)
  - MP3 recording up to 10 minutes with playback preview
- **Recording System:**
  - Web Audio API ScriptProcessorNode captures sidetone PCM audio
  - Buffers Float32 samples in 4096-sample chunks
  - lamejs encoder converts to 128kbps MP3 on stop
  - Playback preview before save/discard decision
  - Automatic filename generation: `vail-practice-YYYYMMDD-HHMMSS.mp3`
- **Enhanced Decoder:**
  - 40+ morse mappings including all prosigns
  - Adaptive dit/dah duration (30-sample rolling average)
  - Automatic character gap (3 dit units) and word gap (7 dit units) detection
  - WPM calculation using PARIS standard
- **UI Features:**
  - Large scrolling textarea with monospace font for decoded output
  - Copy to clipboard functionality
  - Clear output button
  - Real-time statistics badges (chars, words, WPM)
  - Recording controls with pulsing red indicator
  - Playback preview with Save/Discard buttons
- **Integration:**
  - Reuses existing MorseKeyer, MorseSounder, MorseInputHandler
  - Full MIDI and keyboard input support (Left/Right Ctrl, `[`/`]` keys)
  - 4 keyer modes: Straight, Iambic A, Iambic B, Ultimatic
  - Settings persistence to localStorage (WPM, keyer mode)
- Updated [index.html](training/index.html) with Free Practice module HTML (192 lines)
- Added Free Practice styles to [training.css](training/training.css) (102 lines)
- Extended [training.js](training/scripts/training.js) with Free Practice logic (485 lines)
- Updated documentation with complete Free Practice section

### November 8, 2025 - MIDI Support for Send Practice
- **Added MIDI CW key support** to Send Practice module
- Created new `morse-input-handler.js` - unified input manager for both MIDI and keyboard
- **MIDI Features:**
  - Web MIDI API integration for direct browser-to-device connection
  - Auto-detection and connection to MIDI CW keys (Vail adapter, TinyMIDI)
  - Supports Vail Adapter protocol (MIDI notes 0, 1, 2)
  - Supports N6ARA TinyMIDI protocol (MIDI notes 20, 21)
  - Hot-plug support with automatic device reconnection
  - Automatic configuration of adapter (dit duration, keyer mode)
  - Graceful key release on device disconnect
- **Keyboard Support Maintained:**
  - Still supports vband keyboard mode (Left/Right Ctrl, `[`/`]` keys)
  - Seamlessly switches between MIDI and keyboard input
- **Practice-Aware Input:** Only processes CW key input when Send Practice is active
- **Architecture:** Based on Vail Repeater MIDI implementation
- Updated documentation with complete MIDI support details
- Files updated: `morse-input-handler.js` (new), `training.js`, `index.html`

### November 8, 2025 - Copy Practice Enhancements
- **Added CW Academy mode** with 10 progressive beginner sessions
  - Complete character curriculum from Session 1 (AENT) to Session 10 (full alphabet + numbers)
  - Prosign support (AR, BT, BK, SK) introduced in Sessions 8-10
  - 20% chance of prosign practice when available in session
  - Character count slider applies to regular characters; prosigns always single units
- **Improved wrong answer workflow:**
  - "Try again..." visual feedback for 1 second
  - Automatic morse code replay after 1 second delay
  - "Show Answer" button for manual answer reveal
  - Re-enables "Check Answer" button when typing new guess
  - "Continue" button requires manual click to proceed after showing answer
- **Added Character Count control:**
  - Slider from 1-10 characters (default: 1)
  - Shows for: Letters, Numbers, Mixed, Custom, CW Academy modes
  - Hides for: Words, Callsigns, Q Codes modes
- **Auto-capitalization:** Input field automatically converts to uppercase
- **Dark theme consistency:** Fixed Send Practice info box to match dark theme
- **BETA tag:** Added to Send Practice module button
- **UI label update:** Changed "CW Academy Session" to "CWA Beginner Session"

### November 6, 2025 - Send Practice Module Implementation
- **Implemented complete Send Practice module** with USB CW key support
- Created 3 standalone morse input modules for training tools:
  - `morse-sounder.js` - Sidetone audio generator with Web Audio API
  - `morse-decoder.js` - Dit/dah pattern decoder with adaptive timing
  - `morse-keyer.js` - Multi-mode keyer handler (4 modes: Straight, Iambic A/B, Ultimatic)
- **UI Features:**
  - Large target character display (8rem font size)
  - Real-time "What You Sent" output field
  - Send lamp visual indicator (glows on character decode)
  - Practice mode selection (Letters, Numbers, Mixed, Words)
  - Keyer mode selection dropdown
- **Functionality:**
  - Auto-advance to next character on correct send
  - Adaptive timing that adjusts to user's sending speed
  - Manual skip with "Next Character" button
  - Integration with global tone/volume settings
  - Keyboard shortcuts: Left/Right Ctrl or `[`/`]` keys
- Updated [claude.md](claude.md) documentation with complete Send Practice details
- Added CSS styling for send-lamp active state with glow effect

### November 2, 2025 - QSO Simulator USB CW Key Support
- Integrated USB CW key support into QSO Simulator from morsewalker usb-support branch
- Added 4 morse-input modules to QSO Simulator: keyer.js, decoder.js, sounder.js, morse-input.js
- Implemented 4 keyer modes: Straight Key, Iambic A, Iambic B, Ultimatic
- Real-time morse decoding with adaptive speed adjustment
- Configurable sidetone audio synchronized with user settings
- Key mappings: Left/Right Control (primary), `[`/`]` brackets (backup)
- **PRESERVED all existing features including cut numbers functionality**
- Updated netlify-deploy package with complete site structure

---

*Last Updated: 2025-11-23*
*Project Status: BETA - All Modules Functional with USB CW Key Support and MP3 Recording*
