(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const rt=.15,Ot=5e3,Nt=5e3;function z(a){return Math.min(a*2,Nt)}function b(a,t,e){const s=e?t:z(a);return(1-rt)*a+rt*s}function N(){return Ot}function Mt(a){return a<600?"icr":a<2e3?"cr":"learning"}const ot={ICR:600,CR:2e3},Tt={Standard:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,/?","Session 1":"AENT","Session 2":"IOS14","Session 3":"DHLR25","Session 4":"CU","Session 5":"MW36?","Session 6":"FY,","Session 7":"GPQ79/","Session 8":"BV=","Session 9":"JK08+","Session 10":"XZ.>",Special:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,/?=+>!","Letters Only":"ABCDEFGHIJKLMNOPQRSTUVWXYZ","Numbers Only":"0123456789"},yt=["Session 1","Session 2","Session 3","Session 4","Session 5","Session 6","Session 7","Session 8","Session 9","Session 10"];function xt(a,t,e){const s=new Set;for(const i of a){const n=Tt[i];if(n)for(const r of n)s.add(r)}for(const i of t)s.add(i);for(const i of e)s.delete(i);return Array.from(s).sort()}const J={selectedSets:["Standard"],included:[],excluded:[]},X={characterSpeed:25,adaptiveGain:50,toneFrequency:700,volume:.5,repeatUntilCorrect:!1,maxRepeatTries:6,strictNatoMode:!1},at={isRunning:!1,currentChar:null,charPlayedAt:0,sessionStartTime:0,totalCharsThisSession:0,lastBreakReminder:0},q={isCalibrated:!1,calibratedAt:0,calibration:{}},_={practiceMode:"character",wordLength:3},j={enabledFormats:["2x3"]};class Pt{state;listeners=new Map;constructor(){this.state=this.loadFromStorage()||this.getDefaultState()}getDefaultState(){return{settings:{...X},characterSet:{...J},history:{},wordHistory:{},callsignHistory:{},wordModeSettings:{..._},callsignModeSettings:{...j},session:{...at},voiceCalibration:{...q},pronunciationAliases:{},wordPronunciationAliases:{}}}loadFromStorage(){try{const t=localStorage.getItem("morse-icr-state");if(t){const e=JSON.parse(t);return{settings:{...X,...e.settings},characterSet:{...J,...e.characterSet},history:e.history||{},wordHistory:e.wordHistory||{},callsignHistory:e.callsignHistory||{},wordModeSettings:{..._,...e.wordModeSettings},callsignModeSettings:{...j,...e.callsignModeSettings},session:{...at},voiceCalibration:{...q,...e.voiceCalibration},pronunciationAliases:e.pronunciationAliases||{},wordPronunciationAliases:e.wordPronunciationAliases||{}}}}catch(t){console.error("Failed to load state from storage:",t)}return null}saveToStorage(){try{const t={settings:this.state.settings,characterSet:this.state.characterSet,history:this.state.history,wordHistory:this.state.wordHistory,callsignHistory:this.state.callsignHistory,wordModeSettings:this.state.wordModeSettings,callsignModeSettings:this.state.callsignModeSettings,voiceCalibration:this.state.voiceCalibration,pronunciationAliases:this.state.pronunciationAliases,wordPronunciationAliases:this.state.wordPronunciationAliases};localStorage.setItem("morse-icr-state",JSON.stringify(t))}catch(t){console.error("Failed to save state to storage:",t)}}emit(t,e){const s=this.listeners.get(t);s&&s.forEach(n=>n(e));const i=this.listeners.get("*");i&&i.forEach(n=>n(this.state))}subscribe(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{this.listeners.get(t)?.delete(e)}}getState(){return this.state}getSettings(){return this.state.settings}updateSettings(t){this.state.settings={...this.state.settings,...t},this.saveToStorage(),this.emit("settings",this.state.settings)}getCharacterSet(){return this.state.characterSet}getActiveCharacters(){const{selectedSets:t,included:e,excluded:s}=this.state.characterSet;return xt(t,e,s)}updateCharacterSet(t){this.state.characterSet={...this.state.characterSet,...t},this.saveToStorage(),this.emit("characterSet",this.state.characterSet)}getHistory(){return this.state.history}getCharacterHistory(t){return this.state.history[t]||{wma:N(),mostRecent:N(),totalAttempts:0,correctAttempts:0,lastPracticed:0}}updateCharacterHistory(t,e){const s=this.getCharacterHistory(t);this.state.history[t]={...s,...e},this.saveToStorage(),this.emit("history",this.state.history)}setHistory(t){this.state.history=t,this.saveToStorage(),this.emit("history",this.state.history)}resetHistory(){this.state.history={},this.saveToStorage(),this.emit("history",this.state.history)}revertCharacterAttempt(t,e,s,i){const n=this.getCharacterHistory(t);n.totalAttempts<=0||(this.state.history[t]={...n,wma:s,mostRecent:i,totalAttempts:n.totalAttempts-1,correctAttempts:n.correctAttempts-(e?1:0)},this.saveToStorage(),this.emit("history",this.state.history))}getWordHistory(){return this.state.wordHistory}getWordCharacterHistory(t){return this.state.wordHistory[t]||{wma:N(),mostRecent:N(),totalAttempts:0,correctAttempts:0,lastPracticed:0}}updateWordCharacterHistory(t,e){const s=this.getWordCharacterHistory(t);this.state.wordHistory[t]={...s,...e},this.saveToStorage(),this.emit("wordHistory",this.state.wordHistory)}setWordHistory(t){this.state.wordHistory=t,this.saveToStorage(),this.emit("wordHistory",this.state.wordHistory)}resetWordHistory(){this.state.wordHistory={},this.saveToStorage(),this.emit("wordHistory",this.state.wordHistory)}revertWordCharacterAttempts(t,e,s){for(const i of t){const n=this.getWordCharacterHistory(i);if(n.totalAttempts<=0)continue;const r=s[i];r&&(this.state.wordHistory[i]={...n,wma:r.wma,mostRecent:r.mostRecent,totalAttempts:n.totalAttempts-1,correctAttempts:n.correctAttempts-(e?1:0)})}this.saveToStorage(),this.emit("wordHistory",this.state.wordHistory)}getCallsignHistory(){return this.state.callsignHistory}getCallsignCharacterHistory(t){return this.state.callsignHistory[t]||{wma:N(),mostRecent:N(),totalAttempts:0,correctAttempts:0,lastPracticed:0}}updateCallsignCharacterHistory(t,e){const s=this.getCallsignCharacterHistory(t);this.state.callsignHistory[t]={...s,...e},this.saveToStorage(),this.emit("callsignHistory",this.state.callsignHistory)}setCallsignHistory(t){this.state.callsignHistory=t,this.saveToStorage(),this.emit("callsignHistory",this.state.callsignHistory)}resetCallsignHistory(){this.state.callsignHistory={},this.saveToStorage(),this.emit("callsignHistory",this.state.callsignHistory)}revertCallsignCharacterAttempts(t,e,s){for(const i of t){const n=this.getCallsignCharacterHistory(i);if(n.totalAttempts<=0)continue;const r=s[i];r&&(this.state.callsignHistory[i]={...n,wma:r.wma,mostRecent:r.mostRecent,totalAttempts:n.totalAttempts-1,correctAttempts:n.correctAttempts-(e?1:0)})}this.saveToStorage(),this.emit("callsignHistory",this.state.callsignHistory)}getWordModeSettings(){return this.state.wordModeSettings}updateWordModeSettings(t){this.state.wordModeSettings={...this.state.wordModeSettings,...t},this.saveToStorage(),this.emit("wordModeSettings",this.state.wordModeSettings)}getCallsignModeSettings(){return this.state.callsignModeSettings}updateCallsignModeSettings(t){this.state.callsignModeSettings={...this.state.callsignModeSettings,...t},this.saveToStorage(),this.emit("callsignModeSettings",this.state.callsignModeSettings)}getSession(){return this.state.session}updateSession(t){this.state.session={...this.state.session,...t},this.emit("session",this.state.session)}startSession(){this.updateSession({isRunning:!0,sessionStartTime:Date.now(),totalCharsThisSession:0,lastBreakReminder:Date.now()})}stopSession(){this.updateSession({isRunning:!1,currentChar:null})}getVoiceCalibration(){return this.state.voiceCalibration}isVoiceCalibrated(){return this.state.voiceCalibration.isCalibrated}getCalibrationForChar(t){return this.state.voiceCalibration.calibration[t]||[]}addCalibrationEntry(t,e){const s=this.state.voiceCalibration.calibration[t]||[];s.includes(e.toLowerCase())||(this.state.voiceCalibration.calibration[t]=[...s,e.toLowerCase()],this.saveToStorage(),this.emit("voiceCalibration",this.state.voiceCalibration))}setCalibrationForChar(t,e){this.state.voiceCalibration.calibration[t]=e.map(s=>s.toLowerCase()),this.saveToStorage(),this.emit("voiceCalibration",this.state.voiceCalibration)}completeCalibration(){this.state.voiceCalibration.isCalibrated=!0,this.state.voiceCalibration.calibratedAt=Date.now(),this.saveToStorage(),this.emit("voiceCalibration",this.state.voiceCalibration)}clearCalibration(){this.state.voiceCalibration={...q},this.saveToStorage(),this.emit("voiceCalibration",this.state.voiceCalibration)}getUserSpeechMap(){return this.state.voiceCalibration.calibration}getPronunciationAliases(){return this.state.pronunciationAliases}getWordPronunciationAliases(){return this.state.wordPronunciationAliases}getAliasesFor(t,e){return(e?this.state.wordPronunciationAliases:this.state.pronunciationAliases)[t.toUpperCase()]||[]}addPronunciationAlias(t,e,s){const i=t.toUpperCase(),n=e.toUpperCase().trim();if(!n||n.length>50)return;const c=(s?this.state.wordPronunciationAliases:this.state.pronunciationAliases)[i]||[];c.includes(n)||(s?(this.state.wordPronunciationAliases[i]=[...c,n],this.emit("wordPronunciationAliases",this.state.wordPronunciationAliases)):(this.state.pronunciationAliases[i]=[...c,n],this.emit("pronunciationAliases",this.state.pronunciationAliases)),this.saveToStorage())}matchesAlias(t,e,s){const i=this.getAliasesFor(t,s),n=e.toUpperCase().trim();return i.includes(n)}removeAlias(t,e,s){const i=t.toUpperCase(),n=e.toUpperCase().trim(),l=((s?this.state.wordPronunciationAliases:this.state.pronunciationAliases)[i]||[]).filter(h=>h!==n);s?(this.state.wordPronunciationAliases[i]=l,this.emit("wordPronunciationAliases",this.state.wordPronunciationAliases)):(this.state.pronunciationAliases[i]=l,this.emit("pronunciationAliases",this.state.pronunciationAliases)),this.saveToStorage()}clearAllAliases(t){t?(this.state.wordPronunciationAliases={},this.emit("wordPronunciationAliases",this.state.wordPronunciationAliases)):(this.state.pronunciationAliases={},this.emit("pronunciationAliases",this.state.pronunciationAliases)),this.saveToStorage()}importState(t){t.settings&&(this.state.settings={...X,...t.settings}),t.characterSet&&(this.state.characterSet={...J,...t.characterSet}),t.history&&(this.state.history=t.history),t.wordHistory&&(this.state.wordHistory=t.wordHistory),t.callsignHistory&&(this.state.callsignHistory=t.callsignHistory),t.wordModeSettings&&(this.state.wordModeSettings={..._,...t.wordModeSettings}),t.callsignModeSettings&&(this.state.callsignModeSettings={...j,...t.callsignModeSettings}),t.pronunciationAliases&&(this.state.pronunciationAliases=t.pronunciationAliases),t.wordPronunciationAliases&&(this.state.wordPronunciationAliases=t.wordPronunciationAliases),this.saveToStorage(),this.emit("settings",this.state.settings),this.emit("characterSet",this.state.characterSet),this.emit("history",this.state.history),this.emit("wordHistory",this.state.wordHistory),this.emit("callsignHistory",this.state.callsignHistory),this.emit("wordModeSettings",this.state.wordModeSettings),this.emit("callsignModeSettings",this.state.callsignModeSettings),this.emit("pronunciationAliases",this.state.pronunciationAliases),this.emit("wordPronunciationAliases",this.state.wordPronunciationAliases)}}const o=new Pt,V={A:".-",B:"-...",C:"-.-.",D:"-..",E:".",F:"..-.",G:"--.",H:"....",I:"..",J:".---",K:"-.-",L:".-..",M:"--",N:"-.",O:"---",P:".--.",Q:"--.-",R:".-.",S:"...",T:"-",U:"..-",V:"...-",W:".--",X:"-..-",Y:"-.--",Z:"--..",0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----.",".":".-.-.-",",":"--..--","?":"..--..","/":"-..-."};Object.fromEntries(Object.entries(V).map(([a,t])=>[t,a]));const wt=Object.keys(V),Ht={};function D(a){return Ht[a]||a}const R={background:"#12121a",gridLine:"rgba(255, 255, 255, 0.1)",text:"#888",green:"#00d26a",yellow:"#ffc107",red:"#ff4757",dot:"#1a1a2e",dotBorder:"#f0f0f0"},E={paddingTop:30,paddingBottom:30,paddingLeft:50,paddingRight:10,minBarGap:1,maxBarGap:4,minBarWidth:4,maxBarWidth:25,minDotRadius:2,maxDotRadius:4,yAxisMin:100,yAxisMax:5e3};class bt{canvas;ctx;tooltip=null;dataSource="individual";constructor(t){this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.setupCanvas(),this.setupEventListeners(),this.render(),o.subscribe("history",()=>{this.dataSource==="individual"&&this.render()}),o.subscribe("wordHistory",()=>{this.dataSource==="word"&&this.render()}),o.subscribe("callsignHistory",()=>{this.dataSource==="callsign"&&this.render()}),o.subscribe("characterSet",()=>this.render()),window.addEventListener("resize",()=>{this.render()})}setDataSource(t){this.dataSource!==t&&(this.dataSource=t,this.render())}getDataSource(){return this.dataSource}getHistory(){return this.dataSource==="individual"?o.getHistory():this.dataSource==="word"?o.getWordHistory():o.getCallsignHistory()}setupCanvas(){const t=this.canvas.parentElement;if(!t)return;const e=t.getBoundingClientRect(),s=window.devicePixelRatio||1,i=e.width,n=e.height;this.canvas.width=i*s,this.canvas.height=n*s,this.ctx.scale(s,s),this.canvas.style.width=`${i}px`,this.canvas.style.height=`${n}px`}setupEventListeners(){this.canvas.addEventListener("mousemove",t=>this.handleMouseMove(t)),this.canvas.addEventListener("mouseleave",()=>this.hideTooltip()),this.canvas.addEventListener("touchstart",t=>this.handleTouch(t))}handleMouseMove(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;this.checkHover(s,i)}handleTouch(t){t.preventDefault();const e=this.canvas.getBoundingClientRect(),s=t.touches[0],i=s.clientX-e.left,n=s.clientY-e.top;this.checkHover(i,n)}getBarDimensions(t,e){if(e===0)return{barWidth:0,barGap:0,startX:E.paddingLeft,dotRadius:E.maxDotRadius};const s=.2,i=e+(e-1)*s;let n=t/i;n=Math.min(E.maxBarWidth,Math.max(E.minBarWidth,n));let r=n*s;r=Math.min(E.maxBarGap,Math.max(E.minBarGap,r));const c=e*n+(e-1)*r,l=E.paddingLeft+Math.max(0,(t-c)/2),h=Math.min(E.maxDotRadius,Math.max(E.minDotRadius,n/4));return{barWidth:n,barGap:r,startX:l,dotRadius:h}}checkHover(t,e){const s=o.getActiveCharacters(),i=this.getHistory(),r=(parseFloat(this.canvas.style.width)||this.canvas.getBoundingClientRect().width)-E.paddingLeft-E.paddingRight,{barWidth:c,barGap:l,startX:h}=this.getBarDimensions(r,s.length);for(let d=0;d<s.length;d++){const u=s[d],g=h+d*(c+l);if(t>=g&&t<=g+c){const S=i[u],A=S?.wma??5e3,C=S?.mostRecent??5e3;this.showTooltip(u,A,C,g+c/2,E.paddingTop);return}}this.hideTooltip()}showTooltip(t,e,s,i,n){this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.style.cssText=`
        position: absolute;
        background: rgba(18, 18, 26, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 12px;
        color: #f0f0f0;
        pointer-events: none;
        z-index: 100;
        backdrop-filter: blur(10px);
        white-space: nowrap;
      `,this.canvas.parentElement?.appendChild(this.tooltip));const r=D(t);this.tooltip.innerHTML=`
      <strong>${r}</strong><br>
      WMA: ${Math.round(e)}ms<br>
      Recent: ${Math.round(s)}ms
    `,this.tooltip.style.left=`${i}px`,this.tooltip.style.top=`${n-70}px`,this.tooltip.style.display="block"}hideTooltip(){this.tooltip&&(this.tooltip.style.display="none")}valueToY(t,e){const s=Math.log10(E.yAxisMin),i=Math.log10(E.yAxisMax),r=(Math.log10(Math.max(E.yAxisMin,Math.min(E.yAxisMax,t)))-s)/(i-s);return E.paddingTop+e*(1-r)}render(){this.setupCanvas();const t=parseFloat(this.canvas.style.width),e=parseFloat(this.canvas.style.height),s=e-E.paddingTop-E.paddingBottom,i=t-E.paddingLeft-E.paddingRight;this.ctx.fillStyle=R.background,this.ctx.fillRect(0,0,t,e);const n=o.getActiveCharacters(),r=this.getHistory();if(n.length===0){this.ctx.fillStyle=R.text,this.ctx.font="14px system-ui",this.ctx.textAlign="center",this.ctx.fillText("No characters selected",t/2,e/2);return}if(this.dataSource==="word"&&Object.keys(r).length===0){this.ctx.fillStyle=R.text,this.ctx.font="14px system-ui",this.ctx.textAlign="center",this.ctx.fillText("No word practice history yet",t/2,e/2);return}if(this.dataSource==="callsign"&&Object.keys(r).length===0){this.ctx.fillStyle=R.text,this.ctx.font="14px system-ui",this.ctx.textAlign="center",this.ctx.fillText("No callsign practice history yet",t/2,e/2);return}const{barWidth:c,barGap:l,startX:h,dotRadius:d}=this.getBarDimensions(i,n.length);for(let u=0;u<n.length;u++){const g=n[u],S=h+u*(c+l),A=r[g],C=A?.wma??5e3,f=A?.mostRecent??5e3,O=this.valueToY(C,s),M=e-E.paddingBottom-O,P=Mt(C);this.ctx.fillStyle=P==="icr"?R.green:P==="cr"?R.yellow:R.red;const p=Math.min(3,c/3);this.ctx.beginPath(),this.ctx.roundRect(S,O,c,M,[p,p,0,0]),this.ctx.fill();const m=this.valueToY(f,s);if(this.ctx.beginPath(),this.ctx.arc(S+c/2,m,d,0,Math.PI*2),this.ctx.fillStyle=R.dot,this.ctx.fill(),this.ctx.strokeStyle=R.dotBorder,this.ctx.lineWidth=Math.max(1,d/2),this.ctx.stroke(),c>=6){this.ctx.fillStyle=R.text;const W=Math.max(6,Math.min(10,c-1));this.ctx.font=`${W}px monospace`,this.ctx.textAlign="center";const F=D(g),It=c<12?F.charAt(0):F.length>3?F.substring(0,2):F;this.ctx.fillText(It,S+c/2,e-E.paddingBottom+W+2)}}this.ctx.fillStyle=R.background,this.ctx.fillRect(0,0,E.paddingLeft-5,e),this.drawThresholdLines(s,t),this.drawYAxis(s)}drawThresholdLines(t,e){const s=this.valueToY(ot.ICR,t);this.ctx.strokeStyle=R.green,this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.moveTo(E.paddingLeft,s),this.ctx.lineTo(e-E.paddingRight,s),this.ctx.stroke();const i=this.valueToY(ot.CR,t);this.ctx.strokeStyle=R.yellow,this.ctx.beginPath(),this.ctx.moveTo(E.paddingLeft,i),this.ctx.lineTo(e-E.paddingRight,i),this.ctx.stroke(),this.ctx.setLineDash([])}drawYAxis(t){const e=[100,300,600,1e3,2e3,5e3];this.ctx.fillStyle=R.text,this.ctx.font="10px system-ui",this.ctx.textAlign="right";for(const s of e){const i=this.valueToY(s,t);this.ctx.fillText(`${s}`,E.paddingLeft-8,i+3),this.ctx.strokeStyle=R.gridLine,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(E.paddingLeft,i),this.ctx.lineTo(E.paddingLeft+5,i),this.ctx.stroke()}}}const Bt="1.2";function vt(){const a=o.getState(),t={version:Bt,exportedAt:new Date().toISOString(),settings:a.settings,characterSet:a.characterSet,characters:a.history,wordCharacters:a.wordHistory,wordModeSettings:a.wordModeSettings,pronunciationAliases:a.pronunciationAliases,wordPronunciationAliases:a.wordPronunciationAliases},e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");i.href=s;const n=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19);i.download=`morse-icr-history-${n}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}async function Dt(a){try{const t=await a.text(),e=JSON.parse(t);if(!e.version||!e.characters)throw new Error("Invalid history file format");return o.importState({settings:e.settings,characterSet:e.characterSet,history:e.characters,wordHistory:e.wordCharacters||{},wordModeSettings:e.wordModeSettings,pronunciationAliases:e.pronunciationAliases||{},wordPronunciationAliases:e.wordPronunciationAliases||{}}),!0}catch(t){return console.error("Failed to import history:",t),!1}}function Ut(){confirm("Are you sure you want to reset all practice history? This cannot be undone.")&&(o.resetHistory(),o.resetWordHistory())}let Z=null,v=[],U=!1;function w(){return Z||(Z=new AudioContext),Z}function st(){U=!0;for(const a of v)try{a.stop(),a.disconnect()}catch{}v=[]}async function H(){const a=w();a.state==="suspended"&&await a.resume()}function pt(a){const t=1200/a;return{dit:t,dah:t*3,intraCharGap:t,interCharGap:t*3}}function x(a,t,e,s,i){const n=a.createOscillator(),r=a.createGain();n.type="sine",n.frequency.value=t;const c=.005,l=.005;return r.gain.setValueAtTime(0,s),r.gain.linearRampToValueAtTime(i,s+c),r.gain.setValueAtTime(i,s+e-l),r.gain.linearRampToValueAtTime(0,s+e),n.connect(r),r.connect(a.destination),n.start(s),n.stop(s+e),v.push(n),n.onended=()=>{v=v.filter(h=>h!==n)},n}async function ct(a,t=25,e=700,s=.5){st(),U=!1;const i=V[a.toUpperCase()];if(!i)return console.warn(`No morse code found for character: ${a}`),!1;const n=w();await H();const r=pt(t);let c=n.currentTime+.05,l=0;for(let h=0;h<i.length;h++){const u=i[h]==="."?r.dit:r.dah;x(n,e,u/1e3,c,s),c+=u/1e3,l+=u,h<i.length-1&&(c+=r.intraCharGap/1e3,l+=r.intraCharGap)}return new Promise(h=>{setTimeout(()=>{h(!U)},l+50)})}async function G(a,t=25,e=700,s=.5){st(),U=!1;const i=w();await H();const n=pt(t);let r=i.currentTime+.05,c=0;const l=a.toUpperCase().split("");for(let h=0;h<l.length;h++){const d=l[h],u=V[d];if(!u){console.warn(`No morse code found for character: ${d}`);continue}for(let g=0;g<u.length;g++){const A=u[g]==="."?n.dit:n.dah;x(i,e,A/1e3,r,s),r+=A/1e3,c+=A,g<u.length-1&&(r+=n.intraCharGap/1e3,c+=n.intraCharGap)}h<l.length-1&&(r+=n.interCharGap/1e3,c+=n.interCharGap)}return new Promise(h=>{setTimeout(()=>{h(!U)},c+50)})}async function Wt(a=700,t=500,e=.5){const s=w();return await H(),x(s,a,t/1e3,s.currentTime,e),new Promise(i=>{setTimeout(i,t)})}async function k(a=.3){const t=w();await H();const e=.1,s=t.currentTime;x(t,523,e,s,a),x(t,659,e,s+e,a)}async function Q(a=.3){const t=w();await H();const e=.1,s=t.currentTime;x(t,659,e,s,a),x(t,523,e,s+e,a)}const Y={alpha:"A",bravo:"B",charlie:"C",delta:"D",echo:"E",foxtrot:"F",golf:"G",hotel:"H",india:"I",juliet:"J",kilo:"K",lima:"L",mike:"M",november:"N",oscar:"O",papa:"P",quebec:"Q",romeo:"R",sierra:"S",tango:"T",uniform:"U",victor:"V",whiskey:"W",xray:"X","x-ray":"X",yankee:"Y",zulu:"Z",alfa:"A",juliett:"J"},L={a:"A",b:"B",c:"C",d:"D",e:"E",f:"F",g:"G",h:"H",i:"I",j:"J",k:"K",l:"L",m:"M",n:"N",o:"O",p:"P",q:"Q",r:"R",s:"S",t:"T",u:"U",v:"V",w:"W",x:"X",y:"Y",z:"Z",alpha:"A",bravo:"B",charlie:"C",delta:"D",echo:"E",foxtrot:"F",golf:"G",hotel:"H",india:"I",juliet:"J",kilo:"K",lima:"L",mike:"M",november:"N",oscar:"O",papa:"P",quebec:"Q",romeo:"R",sierra:"S",tango:"T",uniform:"U",victor:"V",whiskey:"W",xray:"X","x-ray":"X",yankee:"Y",zulu:"Z",alfa:"A",juliett:"J",ecco:"E",eco:"E",hey:"A",ay:"A",eh:"A",aye:"A","a.":"A",aa:"A",ah:"A",ae:"A",be:"B",bee:"B","b.":"B",bea:"B",beat:"B",bees:"B",beef:"B",see:"C",sea:"C","c.":"C",si:"C",she:"C",seat:"C",seed:"C",de:"D",dee:"D","d.":"D",the:"D",deal:"D",deep:"D",dean:"D",he:"E",ee:"E","e.":"E",ye:"E",me:"E",ea:"E",eee:"E",heat:"E",eat:"E",even:"E",ef:"F",eff:"F","f.":"F",if:"F",have:"F",half:"F",jeff:"F",gee:"G",ge:"G","g.":"G",ji:"G",jee:"G",geez:"G",jeez:"G",jesus:"G",age:"H",ach:"H","h.":"H",aitch:"H",each:"H",ache:"H",ages:"H",eye:"I","i.":"I",hi:"I",high:"I",eyes:"I",ice:"I",jay:"J",je:"J","j.":"J",jae:"J",jade:"J",jays:"J",jane:"J",james:"J",kay:"K",ke:"K","k.":"K",okay:"K",ok:"K",cake:"K",kate:"K",cay:"K",kaye:"K",el:"L",ell:"L","l.":"L",elle:"L",ale:"L",hell:"L",well:"L",bell:"L",em:"M","m.":"M",am:"M",um:"M",him:"M",them:"M",mm:"M",en:"N","n.":"N",and:"N",an:"N",in:"N",end:"N",hen:"N",then:"N",when:"N",oh:"O",owe:"O","o.":"O",eau:"O",oo:"O",ooh:"O",go:"O",no:"O",so:"O",yo:"O",pea:"P",pe:"P","p.":"P",pee:"P",peak:"P",peas:"P",pete:"P",peace:"P",cue:"Q",queue:"Q","q.":"Q",que:"Q",cu:"Q",cute:"Q",are:"R",ar:"R","r.":"R",our:"R",or:"R",err:"R",her:"R",es:"S",ass:"S","s.":"S",yes:"S",is:"S",us:"S",this:"S",has:"S",was:"S",tea:"T",tee:"T","t.":"T",te:"T",ti:"T",teeth:"T",teas:"T",teen:"T",you:"U",ewe:"U","u.":"U",ew:"U",yu:"U",yew:"U",use:"U",used:"U",who:"U",vee:"V",ve:"V","v.":"V",vi:"V",fee:"V",wee:"V",visa:"V","double you":"W","double u":"W","w.":"W",dub:"W",dubs:"W",ex:"X","x.":"X",eggs:"X",axe:"X",ax:"X",next:"X",text:"X",hex:"X",why:"Y","y.":"Y",wie:"Y",wye:"Y",wise:"Y",white:"Y",zee:"Z",zed:"Z","z.":"Z",ze:"Z",said:"Z",seas:"Z",easy:"Z",0:"0",1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",zero:"0",one:"1",two:"2",three:"3",four:"4",five:"5",six:"6",seven:"7",eight:"8",nine:"9",niner:"9",to:"2",too:"2",for:"4",ate:"8",won:"1",tree:"3",free:"3",fiver:"5",sex:"6",sicks:"6",period:".",dot:".",stop:".","full stop":".",".":".",comma:",",",":",",question:"?",query:"?","question mark":"?","?":"?",slash:"/",stroke:"/","forward slash":"/","/":"/",break:"=",bt:"=",pause:"=","bee tee":"=","=":"=",equals:"=",equal:"=",over:"+","a r":"+","+":"+",plus:"+",clear:">",sk:">",out:">","silent key":">","s k":">",">":">"};function y(){return"webkitSpeechRecognition"in window||"SpeechRecognition"in window}function $(){return/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1}function T(){return/Android/i.test(navigator.userAgent)}function et(){return $()||T()}function Ft(a){const t={};for(const[e,s]of Object.entries(a))for(const i of s)t[i.toLowerCase()]=e;return t}function Rt(a,t){const e=a.toLowerCase().trim(),s=o.getSettings(),i=o.getUserSpeechMap();if(Object.keys(i).length>0){const r=Ft(i);if(r[e])return r[e];const c=e.split(" ")[0];if(r[c])return r[c]}if(s.strictNatoMode){if(Y[e])return Y[e];const r=e.split(" ")[0];if(Y[r])return Y[r];if(e.length===1&&/^[a-z]$/.test(e))return e.toUpperCase();const c=["0","1","2","3","4","5","6","7","8","9","zero","one","two","three","four","five","six","seven","eight","nine","niner","to","too","for","ate","won","tree","free","fiver","sex","sicks","period","dot","stop","full stop",".","comma",",","question","query","question mark","?","slash","stroke","forward slash","/","break","bt","pause","bee tee","=","equals","equal","over","a r","+","plus","clear","sk","out","silent key","s k",">"];return c.includes(e)&&L[e]?L[e]:c.includes(r)&&L[r]?L[r]:null}if(L[e])return L[e];const n=e.split(" ")[0];return L[n]?L[n]:e.length===1&&L[e]?L[e]:t&&/^[A-Z]$/.test(t.toUpperCase())&&n.charAt(0).toUpperCase()===t.toUpperCase()?t.toUpperCase():null}class I{recognition=null;isListening=!1;onResultCallback=null;onErrorCallback=null;onRawCallback=null;onEndCallback=null;firstSpeechTime=null;expectedChar=null;continuousMode=!1;isAcceptingResults=!1;lastIgnoredResultIndex=-1;callsignMode=!1;minWordCount=1;constructor(){if(!y()){console.warn("Web Speech API not supported");return}}createRecognitionInstance(){const t=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new t,this.recognition.continuous=this.continuousMode,this.recognition.interimResults=!0,this.recognition.maxAlternatives=3,this.recognition.lang="en-US",this.setupEventHandlers()}setContinuousMode(t){this.continuousMode=t}setupEventHandlers(){this.recognition&&(this.recognition.onstart=()=>{console.log("SpeechRecognizer onstart - recognition service started")},this.recognition.onaudiostart=()=>{console.log("SpeechRecognizer onaudiostart - audio capture started")},this.recognition.onsoundstart=()=>{console.log("SpeechRecognizer onsoundstart - sound detected")},this.recognition.onspeechstart=()=>{console.log("SpeechRecognizer onspeechstart - speech detected")},this.recognition.onspeechend=()=>{console.log("SpeechRecognizer onspeechend - speech ended")},this.recognition.onsoundend=()=>{console.log("SpeechRecognizer onsoundend - sound ended")},this.recognition.onaudioend=()=>{console.log("SpeechRecognizer onaudioend - audio capture ended")},this.recognition.onresult=t=>{if(this.continuousMode&&!this.isAcceptingResults||this.continuousMode&&this.resultAlreadyHandled)return;if(t.resultIndex>this.lastProcessedResultIndex&&(this.lastProcessedResultIndex=t.resultIndex),this.continuousMode&&t.resultIndex<=this.lastIgnoredResultIndex){console.log("Rejecting stale result (index",t.resultIndex,"<= lastIgnored",this.lastIgnoredResultIndex,")");return}const e=performance.now();this.firstSpeechTime===null&&(this.firstSpeechTime=e,console.log("First speech detected, resultIndex:",t.resultIndex));for(let s=t.resultIndex;s<t.results.length;s++){const i=t.results[s];if(this.expectedChar===null){if(i.length>0){const r=i[0].transcript.trim(),c=i[0].confidence;if(this.onRawCallback){const g=i.isFinal?"":" (listening...)";this.onRawCallback(r,r+g)}const l=r.split(/\s+/).filter(g=>g.length>0).length,h=r.length>0&&r.length<=5,d=l>=this.minWordCount,u=i.isFinal||h&&!this.callsignMode||this.callsignMode&&d&&!i.isFinal;if(this.callsignMode&&!i.isFinal&&d)continue;if(u&&r.length>0&&this.onResultCallback){const g=this.firstSpeechTime;this.resultAlreadyHandled=!0,this.onResultCallback({transcript:r,rawTranscript:r,confidence:c,timestamp:g}),this.continuousMode?this.isAcceptingResults=!1:this.stop();return}}continue}for(let r=0;r<i.length;r++){const c=i[r].transcript,l=i[r].confidence,h=Rt(c,this.expectedChar||void 0);if(this.onRawCallback&&this.onRawCallback(c,h),h&&this.onResultCallback){const d=this.firstSpeechTime;this.resultAlreadyHandled=!0,this.onResultCallback({transcript:h,rawTranscript:c,confidence:l,timestamp:d}),i.isFinal&&(this.continuousMode?this.isAcceptingResults=!1:this.stop());return}}if(i.isFinal&&i.length>0&&this.onResultCallback&&this.expectedChar!==null){const r=i[0].transcript.trim();if(r.length>0){const c=this.firstSpeechTime;this.resultAlreadyHandled=!0,this.onResultCallback({transcript:`[unrecognized:${r}]`,rawTranscript:r,confidence:i[0].confidence,timestamp:c}),this.continuousMode?this.isAcceptingResults=!1:this.stop();return}}}},this.recognition.onerror=t=>{if(console.log("SpeechRecognizer onerror:",t.error),t.error==="no-speech"||t.error==="aborted"){this.continuousMode||(this.isListening=!1);return}console.error("Speech recognition error:",t.error),this.isListening=!1,this.onErrorCallback&&this.onErrorCallback(t.error)},this.recognition.onend=()=>{if(console.log("SpeechRecognizer onend, continuousMode:",this.continuousMode,"isListening:",this.isListening),this.continuousMode&&this.isListening){console.log("Continuous mode: auto-restarting recognition");try{this.createRecognitionInstance(),this.lastIgnoredResultIndex=-1,this.lastProcessedResultIndex=-1,this.recognition?.start()}catch(e){console.error("Failed to restart recognition:",e),this.isListening=!1}return}const t=this.isListening;this.isListening=!1,t&&this.onEndCallback&&(console.log("Recognition ended unexpectedly, notifying caller"),this.onEndCallback())})}start(){if(!y()){console.error("Speech recognition not available");return}this.createRecognitionInstance(),this.isListening=!0,this.firstSpeechTime=null,this.lastIgnoredResultIndex=-1,this.lastProcessedResultIndex=-1,this.resultAlreadyHandled=!1;try{console.log("SpeechRecognizer starting..."),this.recognition.start(),console.log("SpeechRecognizer started")}catch(t){console.error("Failed to start speech recognition:",t),this.isListening=!1}}stop(){if(console.log("SpeechRecognizer stop() called, recognition exists:",!!this.recognition,"isListening:",this.isListening),this.isListening=!1,this.isAcceptingResults=!1,this.recognition){console.log("SpeechRecognizer: calling recognition.stop() now");try{this.recognition.stop(),console.log("SpeechRecognizer: recognition.stop() succeeded")}catch(t){console.log("SpeechRecognizer: recognition.stop() threw:",t)}}else console.log("SpeechRecognizer: no recognition instance to stop!")}reset(){console.log("SpeechRecognizer reset() called"),this.stop(),this.recognition=null,this.lastIgnoredResultIndex=-1,this.lastProcessedResultIndex=-1,this.resultAlreadyHandled=!1,this.firstSpeechTime=null}acceptResults(){this.isAcceptingResults=!0,this.firstSpeechTime=null,this.resultAlreadyHandled=!1,console.log("Accepting results, will reject resultIndex <=",this.lastIgnoredResultIndex)}resultAlreadyHandled=!1;lastProcessedResultIndex=-1;ignoreResults(){this.isAcceptingResults=!1,this.lastIgnoredResultIndex=this.lastProcessedResultIndex,console.log("Ignoring results, lastIgnoredResultIndex set to:",this.lastIgnoredResultIndex)}setExpectedChar(t){this.expectedChar=t}setCallsignMode(t,e=3){this.callsignMode=t,this.minWordCount=t?e:1,console.log("Callsign mode:",t,"minWordCount:",this.minWordCount)}onResult(t){this.onResultCallback=t}onError(t){this.onErrorCallback=t}onRaw(t){this.onRawCallback=t}onEnd(t){this.onEndCallback=t}isSupported(){return y()}isActive(){return this.isListening}}const Gt=Tt.Standard.split("");class kt{modal;currentCharEl;heardListEl;progressEl;progressTextEl;statusEl;nextBtn;skipBtn;finishBtn;cancelBtn;recognizer;currentIndex=0;chars=[];isListening=!1;heardTranscripts=[];constructor(){this.createModal(),this.recognizer=new I,this.setupRecognizer()}createModal(){document.body.insertAdjacentHTML("beforeend",`
      <div id="calibration-modal" class="modal hidden">
        <div class="modal-content glass-card calibration-modal">
          <h2>Voice Calibration</h2>
          <p class="calibration-instructions">
            Say each character clearly. We'll record how your voice sounds for better recognition.
            You can say the letter multiple ways (e.g., "E", "Echo", or however you naturally say it).
          </p>

          <div class="calibration-progress">
            <div class="progress-bar">
              <div id="calibration-progress-fill" class="progress-fill"></div>
            </div>
            <span id="calibration-progress-text">0 / 0</span>
          </div>

          <div class="calibration-char-display">
            <span class="label">Say this character:</span>
            <span id="calibration-current-char" class="big-char">A</span>
          </div>

          <div id="calibration-status" class="calibration-status">
            Press "Start Recording" to begin
          </div>

          <div class="calibration-heard">
            <span class="label">Heard patterns:</span>
            <div id="calibration-heard-list" class="heard-list"></div>
          </div>

          <div class="calibration-controls">
            <button id="calibration-record-btn" class="primary-btn">Start Recording</button>
            <button id="calibration-next-btn" class="secondary-btn" disabled>Next Character</button>
            <button id="calibration-skip-btn" class="secondary-btn">Skip</button>
          </div>

          <div class="calibration-actions">
            <button id="calibration-cancel-btn" class="danger-btn">Cancel</button>
            <button id="calibration-finish-btn" class="primary-btn" disabled>Finish Calibration</button>
          </div>
        </div>
      </div>
    `),this.modal=document.getElementById("calibration-modal"),this.currentCharEl=document.getElementById("calibration-current-char"),this.heardListEl=document.getElementById("calibration-heard-list"),this.progressEl=document.getElementById("calibration-progress-fill"),this.progressTextEl=document.getElementById("calibration-progress-text"),this.statusEl=document.getElementById("calibration-status"),this.nextBtn=document.getElementById("calibration-next-btn"),this.skipBtn=document.getElementById("calibration-skip-btn"),this.finishBtn=document.getElementById("calibration-finish-btn"),this.cancelBtn=document.getElementById("calibration-cancel-btn");const e=document.getElementById("calibration-record-btn");e.addEventListener("click",()=>this.toggleRecording(e)),this.nextBtn.addEventListener("click",()=>this.nextCharacter()),this.skipBtn.addEventListener("click",()=>this.skipCharacter()),this.finishBtn.addEventListener("click",()=>this.finishCalibration()),this.cancelBtn.addEventListener("click",()=>this.close())}setupRecognizer(){this.recognizer.onRaw((t,e)=>{if(!this.isListening)return;const s=t.toLowerCase().trim();if(s&&!this.heardTranscripts.includes(s)){this.heardTranscripts.push(s),this.updateHeardList();const i=this.chars[this.currentIndex];o.addCalibrationEntry(i,s),this.nextBtn.removeAttribute("disabled")}})}toggleRecording(t){this.isListening?this.stopRecording(t):this.startRecording(t)}startRecording(t){this.isListening=!0,this.recognizer.start(),t.textContent="Stop Recording",t.classList.add("recording"),this.statusEl.textContent="Listening... Say the character!",this.statusEl.classList.add("listening")}stopRecording(t){this.isListening=!1,this.recognizer.stop(),t.textContent="Start Recording",t.classList.remove("recording"),this.statusEl.textContent=this.heardTranscripts.length>0?`Recorded ${this.heardTranscripts.length} pattern(s). Click Next or record more.`:"No patterns recorded. Try again or skip.",this.statusEl.classList.remove("listening")}updateHeardList(){this.heardListEl.innerHTML=this.heardTranscripts.map(t=>`<span class="heard-tag">${t}</span>`).join("")}nextCharacter(){const t=document.getElementById("calibration-record-btn");if(this.isListening&&this.stopRecording(t),this.currentIndex++,this.currentIndex>=this.chars.length){this.finishBtn.removeAttribute("disabled"),this.statusEl.textContent="All characters calibrated! Click Finish to save.";return}this.showCurrentChar()}skipCharacter(){const t=document.getElementById("calibration-record-btn");if(this.isListening&&this.stopRecording(t),this.currentIndex++,this.currentIndex>=this.chars.length){this.finishBtn.removeAttribute("disabled"),this.statusEl.textContent="Calibration complete! Click Finish to save.";return}this.showCurrentChar()}showCurrentChar(){const t=this.chars[this.currentIndex];this.currentCharEl.textContent=t,this.heardTranscripts=[...o.getCalibrationForChar(t)],this.updateHeardList();const e=this.currentIndex/this.chars.length*100;this.progressEl.style.width=`${e}%`,this.progressTextEl.textContent=`${this.currentIndex} / ${this.chars.length}`,this.nextBtn.setAttribute("disabled","true"),this.heardTranscripts.length>0&&this.nextBtn.removeAttribute("disabled"),this.statusEl.textContent='Press "Start Recording" to begin',this.statusEl.classList.remove("listening")}finishCalibration(){o.completeCalibration(),this.close()}open(t){this.chars=t||[...Gt],this.currentIndex=0,this.heardTranscripts=[],this.finishBtn.setAttribute("disabled","true"),this.showCurrentChar(),this.modal.classList.remove("hidden")}close(){const t=document.getElementById("calibration-record-btn");this.isListening&&this.stopRecording(t),this.modal.classList.add("hidden")}}class Yt{panel;settingsToggle;closeBtn;speedSlider;speedValue;gainSlider;gainValue;repeatToggle;maxTriesSlider;maxTriesValue;maxTriesGroup;strictNatoToggle;freqSlider;freqValue;characterSetsEl;customCharsEl;saveBtn;loadBtn;fileInput;resetBtn;voiceCalibration;calibrateBtn=null;clearCalibrationBtn=null;calibrationStatusEl=null;constructor(){this.panel=document.getElementById("settings-panel"),this.settingsToggle=document.getElementById("settings-toggle"),this.closeBtn=document.getElementById("close-settings"),this.speedSlider=document.getElementById("speed-slider"),this.speedValue=document.getElementById("speed-value"),this.gainSlider=document.getElementById("gain-slider"),this.gainValue=document.getElementById("gain-value"),this.repeatToggle=document.getElementById("repeat-toggle"),this.maxTriesSlider=document.getElementById("max-tries-slider"),this.maxTriesValue=document.getElementById("max-tries-value"),this.maxTriesGroup=document.getElementById("max-tries-group"),this.strictNatoToggle=document.getElementById("strict-nato-toggle"),this.freqSlider=document.getElementById("freq-slider"),this.freqValue=document.getElementById("freq-value"),this.characterSetsEl=document.getElementById("character-sets"),this.customCharsEl=document.getElementById("custom-chars"),this.saveBtn=document.getElementById("save-history"),this.loadBtn=document.getElementById("load-history"),this.fileInput=document.getElementById("history-file"),this.resetBtn=document.getElementById("reset-history"),this.voiceCalibration=new kt,this.insertCalibrationSection(),this.setupEventListeners(),this.initializeValues(),this.renderCharacterSets(),this.renderCustomCharacters(),this.updateCalibrationStatus()}insertCalibrationSection(){if(et())return;const t=this.panel.querySelector(".setting-group.actions");if(!t)return;const e=document.createElement("div");e.className="setting-group",e.innerHTML=`
      <h3>Voice Calibration</h3>
      <p class="calibration-info">Train the app to recognize your voice for better accuracy.</p>
      <div id="calibration-status" class="calibration-status-display"></div>
      <div class="calibration-buttons">
        <button id="calibrate-btn" class="secondary-btn">Calibrate Voice</button>
        <button id="clear-calibration-btn" class="secondary-btn" style="display: none;">Clear Calibration</button>
      </div>
    `,t.parentNode?.insertBefore(e,t),this.calibrateBtn=document.getElementById("calibrate-btn"),this.clearCalibrationBtn=document.getElementById("clear-calibration-btn"),this.calibrationStatusEl=document.getElementById("calibration-status"),this.calibrateBtn.addEventListener("click",()=>{this.voiceCalibration.open()}),this.clearCalibrationBtn.addEventListener("click",()=>{confirm("Clear all voice calibration data?")&&(o.clearCalibration(),this.updateCalibrationStatus())}),o.subscribe("voiceCalibration",()=>this.updateCalibrationStatus())}updateCalibrationStatus(){if(!this.calibrationStatusEl||!this.clearCalibrationBtn)return;const t=o.getVoiceCalibration(),e=Object.keys(t.calibration).length;if(t.isCalibrated){const s=new Date(t.calibratedAt).toLocaleDateString();this.calibrationStatusEl.innerHTML=`
        <span class="status-icon">âœ“</span>
        Calibrated on ${s} (${e} characters)
      `,this.calibrationStatusEl.className="calibration-status-display calibrated",this.clearCalibrationBtn.style.display="inline-block"}else e>0?(this.calibrationStatusEl.innerHTML=`
        <span class="status-icon">â‹¯</span>
        Partial calibration (${e} characters)
      `,this.calibrationStatusEl.className="calibration-status-display partial",this.clearCalibrationBtn.style.display="inline-block"):(this.calibrationStatusEl.innerHTML=`
        <span class="status-icon">â—‹</span>
        Not calibrated
      `,this.calibrationStatusEl.className="calibration-status-display",this.clearCalibrationBtn.style.display="none")}setupEventListeners(){this.settingsToggle.addEventListener("click",()=>this.toggle()),this.closeBtn.addEventListener("click",()=>this.close()),this.panel.addEventListener("click",t=>{t.target===this.panel&&this.close()}),this.speedSlider.addEventListener("input",()=>{const t=parseInt(this.speedSlider.value);this.speedValue.textContent=t.toString(),o.updateSettings({characterSpeed:t})}),this.gainSlider.addEventListener("input",()=>{const t=parseInt(this.gainSlider.value);this.gainValue.textContent=t.toString(),o.updateSettings({adaptiveGain:t})}),this.repeatToggle.addEventListener("change",()=>{o.updateSettings({repeatUntilCorrect:this.repeatToggle.checked}),this.updateMaxTriesVisibility()}),this.maxTriesSlider.addEventListener("input",()=>{const t=parseInt(this.maxTriesSlider.value);this.maxTriesValue.textContent=t===6?"Unlimited":t.toString(),o.updateSettings({maxRepeatTries:t})}),this.strictNatoToggle.addEventListener("change",()=>{o.updateSettings({strictNatoMode:this.strictNatoToggle.checked})}),this.freqSlider.addEventListener("input",()=>{const t=parseInt(this.freqSlider.value);this.freqValue.textContent=t.toString(),o.updateSettings({toneFrequency:t})}),this.freqSlider.addEventListener("change",()=>{const t=o.getSettings();Wt(t.toneFrequency,200,t.volume)}),this.saveBtn.addEventListener("click",()=>vt()),this.loadBtn.addEventListener("click",()=>this.fileInput.click()),this.fileInput.addEventListener("change",async()=>{const t=this.fileInput.files?.[0];t&&(await Dt(t)?(this.initializeValues(),this.renderCharacterSets(),this.renderCustomCharacters(),alert("History loaded successfully!")):alert("Failed to load history file."),this.fileInput.value="")}),this.resetBtn.addEventListener("click",()=>Ut()),o.subscribe("settings",()=>this.initializeValues()),o.subscribe("characterSet",()=>{this.renderCharacterSets(),this.renderCustomCharacters()})}initializeValues(){const t=o.getSettings();this.speedSlider.value=t.characterSpeed.toString(),this.speedValue.textContent=t.characterSpeed.toString(),this.gainSlider.value=t.adaptiveGain.toString(),this.gainValue.textContent=t.adaptiveGain.toString(),this.repeatToggle.checked=t.repeatUntilCorrect,this.maxTriesSlider.value=t.maxRepeatTries.toString(),this.maxTriesValue.textContent=t.maxRepeatTries===6?"Unlimited":t.maxRepeatTries.toString(),this.updateMaxTriesVisibility(),this.strictNatoToggle.checked=t.strictNatoMode,this.freqSlider.value=t.toneFrequency.toString(),this.freqValue.textContent=t.toneFrequency.toString()}updateMaxTriesVisibility(){o.getSettings().repeatUntilCorrect?this.maxTriesGroup.classList.remove("hidden"):this.maxTriesGroup.classList.add("hidden")}renderCharacterSets(){const t=o.getCharacterSet(),e=["Standard","Letters Only","Numbers Only",...yt];this.characterSetsEl.innerHTML="";for(const s of e){const i=document.createElement("button");i.textContent=s,i.className=t.selectedSets.includes(s)?"active":"",i.addEventListener("click",()=>{const n=o.getCharacterSet();let r;n.selectedSets.includes(s)?r=n.selectedSets.filter(c=>c!==s):r=[...n.selectedSets,s],r.length===0&&(r=["Standard"]),o.updateCharacterSet({selectedSets:r})}),this.characterSetsEl.appendChild(i)}}renderCustomCharacters(){const t=o.getCharacterSet(),e=o.getActiveCharacters();this.customCharsEl.innerHTML="";for(const s of wt){const i=document.createElement("button");i.textContent=D(s);const n=e.includes(s);t.excluded.includes(s)?(i.className="excluded",i.title="Excluded (click to include)"):n?(i.className="active",i.title="Active (click to exclude)"):i.title="Not in selected sets (click to include)",i.addEventListener("click",()=>{const c=o.getCharacterSet();let l=[...c.included],h=[...c.excluded];c.excluded.includes(s)?h=h.filter(d=>d!==s):e.includes(s)?(h.push(s),l=l.filter(d=>d!==s)):l.push(s),o.updateCharacterSet({included:l,excluded:h})}),this.customCharsEl.appendChild(i)}}toggle(){this.panel.classList.toggle("hidden"),this.panel.classList.toggle("visible")}open(){this.panel.classList.remove("hidden"),this.panel.classList.add("visible")}close(){this.panel.classList.add("hidden"),this.panel.classList.remove("visible")}}class Kt{testBtn;levelContainer;levelBar;resultEl;recognition=null;audioContext=null;analyser=null;mediaStream=null;animationId=null;isTesting=!1;constructor(){this.testBtn=document.getElementById("mic-test-btn"),this.levelContainer=document.getElementById("mic-level-container"),this.levelBar=document.getElementById("mic-level"),this.resultEl=document.getElementById("mic-result"),this.setupEventListeners(),this.checkSupport()}checkSupport(){if(!y()){const e=$()?"Speech recognition requires Safari on iOS. Also ensure Siri is enabled in Settings.":"Speech recognition not supported. Try Chrome, Edge, or Safari.";this.resultEl.innerHTML=`<span class="error">${e}</span>`,this.testBtn.disabled=!0;return}const t=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new t,this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.maxAlternatives=5,this.recognition.lang="en-US",this.setupRecognitionHandlers()}setupEventListeners(){this.testBtn.addEventListener("click",()=>this.toggleTest())}setupRecognitionHandlers(){this.recognition&&(this.recognition.onaudiostart=()=>{console.log("onaudiostart fired"),this.resultEl.innerHTML='<span class="listening">ðŸŽ¤ Listening... Say any letter (like "A", "B", "Alpha", etc.)</span>'},this.recognition.onstart=()=>{console.log("onstart fired - recognition is active")},this.recognition.onspeechstart=()=>{console.log("onspeechstart fired - speech detected")},this.recognition.onspeechend=()=>{console.log("onspeechend fired - speech ended")},this.recognition.onresult=t=>{let e="",s=null;for(let i=t.resultIndex;i<t.results.length;i++){const n=t.results[i];for(let r=0;r<n.length;r++){const c=n[r].transcript,l=Rt(c);e||(e=c),l&&!s&&(s=l)}if(n.isFinal){this.stopTest(),s?this.resultEl.innerHTML=`
              <span class="success">âœ“ Heard: "${e}" â†’ Recognized as: <strong>${s}</strong></span>
              <br><small style="color: var(--text-muted);">Microphone is working! You can start practicing.</small>
            `:this.resultEl.innerHTML=`
              <span class="error">âœ— Heard: "${e}" - Not recognized as a valid character.</span>
              <br><small style="color: var(--text-muted);">Try saying a single letter like "A", "B", or use NATO phonetic like "Alpha", "Bravo".</small>
            `;return}}e&&(this.resultEl.innerHTML=`<span class="listening">Hearing: "${e}"...</span>`)},this.recognition.onerror=t=>{console.log("onerror fired:",t.error),t.error==="not-allowed"?(this.resultEl.innerHTML=`
          <span class="error">âœ— Microphone access denied!</span>
          <br><small style="color: var(--text-muted);">Click the lock icon in your browser's address bar and allow microphone access, then refresh.</small>
        `,this.stopTest()):t.error==="no-speech"?(this.resultEl.innerHTML=`
          <span class="error">âœ— No speech detected.</span>
          <br><small style="color: var(--text-muted);">Make sure your microphone is working and speak clearly. Check your system audio settings.</small>
        `,this.stopTest()):t.error==="audio-capture"&&(this.resultEl.innerHTML=`
          <span class="error">âœ— No microphone found!</span>
          <br><small style="color: var(--text-muted);">Please connect a microphone and refresh the page.</small>
        `,this.stopTest())},this.recognition.onend=()=>{console.log("onend fired - isTesting:",this.isTesting),this.isTesting&&(this.resultEl.innerHTML=`
          <span class="error">âœ— No speech detected in time.</span>
          <br><small style="color: var(--text-muted);">Try again - speak clearly and loudly.</small>
        `,this.stopTest())})}async toggleTest(){this.isTesting?this.stopTest():await this.startTest()}async startTest(){if(this.isTesting=!0,this.testBtn.textContent="Stop Test",this.testBtn.classList.add("testing"),this.levelContainer.classList.remove("hidden"),this.resultEl.innerHTML='<span class="listening">Starting microphone...</span>',y()){const t=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new t,this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.maxAlternatives=5,this.recognition.lang="en-US",this.setupRecognitionHandlers(),console.log("Created fresh SpeechRecognition instance")}try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=new AudioContext,this.analyser=this.audioContext.createAnalyser(),this.audioContext.createMediaStreamSource(this.mediaStream).connect(this.analyser),this.analyser.fftSize=256,this.updateLevel();const e=this.mediaStream.getAudioTracks();e.length>0&&(console.log("Using microphone:",e[0].label),this.resultEl.innerHTML=`<span class="listening">Using: ${e[0].label||"Default Microphone"}</span>`)}catch(t){console.error("Failed to get audio stream:",t),this.resultEl.innerHTML=`
        <span class="error">âœ— Could not access microphone.</span>
        <br><small style="color: var(--text-muted);">Please allow microphone access when prompted.</small>
      `,this.stopTest();return}if(this.recognition)try{console.log("Calling recognition.start()..."),this.recognition.start(),console.log("recognition.start() called successfully")}catch(t){console.error("Failed to start recognition:",t),this.resultEl.innerHTML=`
          <span class="error">âœ— Failed to start speech recognition</span>
          <br><small style="color: var(--text-muted);">Error: ${t}</small>
        `}}stopTest(){if(this.isTesting=!1,this.testBtn.textContent="Test Microphone",this.testBtn.classList.remove("testing"),this.levelContainer.classList.add("hidden"),this.levelBar.style.width="0%",this.recognition)try{this.recognition.stop()}catch{}this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>t.stop()),this.mediaStream=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}updateLevel(){if(!this.analyser||!this.isTesting)return;const t=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteFrequencyData(t);const e=t.reduce((i,n)=>i+n,0)/t.length,s=Math.min(100,e/128*100);this.levelBar.style.width=`${s}%`,this.animationId=requestAnimationFrame(()=>this.updateLevel())}}const zt=["ACE","ACT","ADD","AGE","AID","AIM","AIR","ANT","APE","ARC","ARK","ARM","ART","ASH","AXE","BAD","BAG","BAT","BED","BIG","BIT","BOW","BOX","BOY","BUD","BUG","BUS","BUT","BUY","CAB","CAP","CAR","CAT","COB","COD","COG","COP","COT","COW","CRY","CUB","CUP","CUT","DAM","DAY","DEN","DEW","DIG","DIM","DOC","DOG","DOT","DRY","DUG","DYE","EAR","EAT","EGG","ELF","ELK","ELM","END","ERA","FAN","FAR","FAT","FAX","FED","FIG","FIN","FIT","FIX","FLY","FOB","FOG","FOR","FOX","FUN","FUR","GAP","GAS","GEL","GEM","GIG","GIN","GNU","GOB","GOD","GUM","GUN","GUT","GUY","GYM","HAM","HAT","HAY","HEN","HID","HIP","HIT","HOB","HOG","HOP","HOT","HUB","HUG","HUM","HUT","ICE","ICY","IMP","INK","INN","ION","IVY","JAB","JAM","JAR","JAW","JET","JIG","JOB","JOG","JOT","JOY","JUG","KID","KIN","KIT","LAB","LAD","LAP","LAW","LAY","LED","LEG","LET","LID","LIP","LIT","LOG","LOT","LOW","MAD","MAN","MAP","MAT","MAX","MEN","MET","MIX","MOB","MOM","MOP","MUD","MUG","NAP","NET","NEW","NIT","NOD","NOR","NOT","NOW","NUN","NUT","OAK","OAR","OAT","ODD","OIL","OLD","ONE","OPT","ORB","ORE","OUR","OUT","OWL","OWN","PAD","PAN","PAT","PAW","PAY","PEG","PEN","PET","PIE","PIG","PIN","PIT","PLY","POD","POP","POT","PRY","PUB","PUN","PUP","PUT","RAG","RAM","RAN","RAP","RAT","RAW","RAY","RED","REP","RIB","RID","RIG","RIM","RIP","ROB","ROD","ROT","ROW","RUB","RUG","RUN","RUT","RYE","SAD","SAP","SAT","SAW","SAY","SET","SEW","SHY","SIN","SIP","SIS","SIT","SIX","SKI","SKY","SLY","SOB","SOD","SON","SOP","SOT","SOW","SOY","SPA","SPY","STY","SUB","SUM","SUN","TAB","TAG","TAN","TAP","TAR","TAX","TEN","THE","TIE","TIN","TIP","TOE","TON","TOO","TOP","TOT","TOW","TOY","TUB","TUG","TWO","URN","USE","VAN","VAT","VET","VIA","VOW","WAD","WAR","WAS","WAX","WAY","WEB","WED","WET","WHO","WIG","WIN","WIT","WOK","WON","WOO","YAK","YAM","YAP","YAW","YEN","YES","YET","YIN","ZIP","ZIT","ZOO"],Vt=["ABLE","ACHE","ACID","AGED","AIDE","AIMS","ALSO","ARCH","AREA","ARMY","AUNT","AUTO","BABY","BACK","BAKE","BALL","BAND","BANK","BARN","BASE","BATH","BEAD","BEAM","BEAN","BEAR","BEAT","BEEF","BEER","BELL","BELT","BEND","BENT","BEST","BIKE","BIRD","BITE","BLOW","BLUE","BOAT","BODY","BOIL","BOLD","BOLT","BOMB","BOND","BONE","BOOK","BOOM","BOOT","BORN","BOSS","BOTH","BOWL","BROW","BULB","BULK","BULL","BUMP","BURN","BUSH","BUSY","CAFE","CAGE","CAKE","CALF","CALL","CALM","CAME","CAMP","CANE","CAPE","CARD","CARE","CART","CASE","CASH","CAST","CAVE","CELL","CHEF","CHIN","CHIP","CHOP","CITY","CLAM","CLAP","CLAY","CLIP","CLUB","CLUE","COAL","COAT","CODE","COIL","COIN","COLD","COLT","COMB","COME","CONE","COOK","COOL","COPE","COPY","CORD","CORE","CORK","CORN","COST","COZY","CRAB","CREW","CROP","CROW","CUBE","CULT","CUPS","CURB","CURE","CURL","CUTE","DAMP","DARE","DARK","DASH","DATA","DATE","DAWN","DAYS","DEAD","DEAF","DEAL","DEAN","DEAR","DEBT","DECK","DEED","DEEP","DEER","DEMO","DENY","DESK","DIAL","DICE","DIET","DIME","DINE","DIRT","DISC","DISH","DISK","DIVE","DOCK","DOES","DOLL","DOME","DONE","DOOR","DOSE","DOWN","DRAW","DREW","DRIP","DROP","DRUM","DUAL","DUCK","DUDE","DUEL","DUKE","DULL","DUMP","DUNE","DUNK","DUSK","DUST","DUTY","EACH","EARL","EARN","EASE","EAST","EASY","ECHO","EDGE","EDIT","ELSE","EPIC","EURO","EVEN","EVIL","EXAM","EXIT","EXPO","FACE","FACT","FADE","FAIL","FAIR","FAKE","FALL","FAME","FARM","FAST","FATE","FAWN","FEAR","FEAT","FEED","FEEL","FEET","FELL","FELT","FERN","FEST","FEUD","FILE","FILL","FILM","FIND","FINE","FIRE","FIRM","FISH","FIST","FLAG","FLAP","FLAT","FLAW","FLEA","FLED","FLEW","FLIP","FLOW","FOAM","FOIL","FOLD","FOLK","FOND","FONT","FOOD","FOOL","FOOT","FORD","FORK","FORM","FORT","FOUL","FOUR","FOWL","FREE","FROM","FROG","FUEL","FULL","FUME","FUND","FUNK","FUSE","FUSS","GAIN","GALE","GAME","GANG","GASP","GATE","GAVE","GAZE","GEAR","GENE","GIFT","GIRL","GIVE","GLAD","GLOW","GLUE","GOAL","GOAT","GOES","GOLD","GOLF","GONE","GOOD","GOWN","GRAB","GRAM","GRAY","GREW","GRID","GRIM","GRIN","GRIP","GRIT","GROW","GULF","GURU","GUST","HACK","HAIL","HAIR","HALF","HALL","HALT","HAND","HANG","HARD","HARM","HARP","HATE","HAUL","HAVE","HAWK","HEAD","HEAL","HEAP","HEAR","HEAT","HEEL","HELD","HELP","HEMP","HERB","HERD","HERE","HERO","HIGH","HIKE","HILL","HINT","HIRE","HOLD","HOLE","HOME","HOOD","HOOK","HOPE","HORN","HOST","HOUR","HUGE","HULL","HUNG","HUNT","HURT","HUSK","ICON","IDEA","IDLE","INCH","INTO","IRON","ITEM","JACK","JADE","JAIL","JAZZ","JEAN","JEEP","JEST","JOBS","JOIN","JOKE","JOLT","JUMP","JUNE","JUNK","JURY","JUST","KEEN","KEEP","KELP","KEPT","KICK","KIDS","KILL","KIND","KING","KISS","KITE","KNEE","KNEW","KNIT","KNOB","KNOT","KNOW","LACE","LACK","LAKE","LAMB","LAMP","LAND","LANE","LARD","LAST","LATE","LAWN","LEAD","LEAF","LEAK","LEAN","LEAP","LEFT","LEND","LENS","LESS","LIDS","LIFE","LIFT","LIKE","LIMB","LIME","LIMP","LINE","LINK","LION","LIPS","LIST","LIVE","LOAD","LOAF","LOAN","LOBE","LOCK","LOFT","LOGO","LONG","LOOK","LOOP","LORD","LOSE","LOSS","LOST","LOTS","LOUD","LOVE","LUCK","LUMP","LUNG","LURE","MADE","MAID","MAIL","MAIN","MAKE","MALE","MALL","MALT","MANY","MAPS","MARE","MARK","MARS","MASH","MASK","MASS","MAST","MATE","MATH","MEAL","MEAN","MEAT","MEEK","MEET","MELT","MEMO","MENU","MESH","MESS","MILD","MILE","MILK","MILL","MIND","MINE","MINT","MISS","MIST","MODE","MOLD","MONK","MOOD","MOON","MOOR","MORE","MOSS","MOST","MOTH","MOVE","MUCH","MULE","MUST","MYTH","NAIL","NAME","NAVY","NEAR","NEAT","NECK","NEED","NEST","NEWS","NEXT","NICE","NINE","NODE","NONE","NOON","NORM","NOSE","NOTE","NOUN","NUDE","NUTS","OATH","ODDS","OILS","OKAY","ONCE","ONLY","ONTO","OPEN","ORAL","OVEN","OVER","PACE","PACK","PAGE","PAID","PAIL","PAIN","PAIR","PALE","PALM","PANE","PARK","PART","PASS","PAST","PATH","PEAK","PEAR","PEAS","PEAT","PECK","PEEK","PEEL","PEER","PELT","PENS","PERK","PEST","PICK","PIER","PIKE","PILE","PILL","PINE","PINK","PINT","PIPE","PITS","PLAN","PLAY","PLEA","PLOD","PLOT","PLOW","PLUG","PLUM","PLUS","POCK","PODS","POEM","POET","POLE","POLL","POLO","POND","PONY","POOL","POOR","POPE","PORK","PORT","POSE","POST","POUR","PRAY","PREY","PROP","PULL","PULP","PUMP","PUNK","PURE","PUSH","QUIT","QUIZ","RACE","RACK","RAFT","RAGE","RAID","RAIL","RAIN","RAKE","RAMP","RANG","RANK","RARE","RASH","RATE","RAVE","READ","REAL","REAP","REAR","REED","REEF","REEL","RELY","RENT","REST","RICE","RICH","RIDE","RIFF","RIFT","RING","RIOT","RIPE","RISE","RISK","ROAD","ROAM","ROAR","ROBE","ROCK","RODE","ROLE","ROLL","ROOF","ROOM","ROOT","ROPE","ROSE","ROSY","ROUT","RUDE","RUIN","RULE","RUMP","RUNG","RUNS","RUSH","RUST","SACK","SAFE","SAGE","SAID","SAIL","SAKE","SALE","SALT","SAME","SAND","SANE","SANG","SANK","SAVE","SAYS","SCAN","SCAR","SEAL","SEAM","SEAT","SECT","SEED","SEEK","SEEM","SEEN","SELF","SELL","SEND","SENT","SHED","SHIP","SHOP","SHOT","SHOW","SHUT","SICK","SIDE","SIFT","SIGH","SIGN","SILK","SING","SINK","SITE","SIZE","SKIM","SKIN","SKIP","SLAB","SLAM","SLAP","SLAT","SLED","SLEW","SLID","SLIM","SLIP","SLIT","SLOT","SLOW","SLUG","SLUM","SNAP","SNOB","SNOW","SNUB","SNUG","SOAK","SOAP","SOAR","SOCK","SODA","SOFA","SOFT","SOIL","SOLD","SOLE","SOME","SONG","SOON","SOOT","SORE","SORT","SOUL","SOUP","SOUR","SPAN","SPAR","SPEC","SPED","SPIN","SPIT","SPOT","SPUN","SPUR","STAB","STAG","STAR","STAY","STEM","STEP","STEW","STIR","STOP","STUB","STUD","STUN","SUCH","SUIT","SULK","SUNG","SUNK","SURE","SURF","SWAN","SWAP","SWIM","TACK","TAIL","TAKE","TALE","TALK","TALL","TAME","TANK","TAPE","TAPS","TASK","TAXI","TEAM","TEAR","TELL","TEND","TENT","TERM","TEST","TEXT","THAN","THAT","THEM","THEN","THEY","THIN","THIS","THUS","TICK","TIDE","TIDY","TIED","TIER","TIES","TILE","TILL","TILT","TIME","TINT","TINY","TIPS","TIRE","TOAD","TOES","TOIL","TOLD","TOLL","TOMB","TONE","TONS","TOOK","TOOL","TOPS","TORE","TORN","TORT","TOSS","TOUR","TOWN","TRAP","TRAY","TREE","TREK","TRIM","TRIO","TRIP","TROD","TROT","TRUE","TUBE","TUCK","TUFT","TUNE","TURN","TWIN","TYPE","UGLY","UNDO","UNIT","UPON","URGE","USED","USER","VAIN","VALE","VANE","VARY","VASE","VAST","VEAL","VEIN","VENT","VERB","VERY","VEST","VETO","VICE","VIEW","VINE","VISA","VOID","VOLT","VOTE","WADE","WAGE","WAIT","WAKE","WALK","WALL","WAND","WANT","WARD","WARM","WARN","WARP","WART","WARY","WASH","WASP","WAVE","WAVY","WAXY","WAYS","WEAK","WEAR","WEBS","WEED","WEEK","WEEP","WELD","WELL","WENT","WEPT","WERE","WEST","WHAT","WHEN","WICK","WIDE","WIFE","WILD","WILL","WILT","WIMP","WIND","WINE","WING","WINK","WINS","WIPE","WIRE","WISE","WISH","WITH","WOKE","WOLF","WOMB","WONT","WOOD","WOOL","WORD","WORE","WORK","WORM","WORN","WRAP","YARD","YARN","YAWN","YEAR","YELL","YOUR","ZEAL","ZERO","ZEST","ZINC","ZONE","ZOOM"],$t=["ABOVE","ABUSE","ACTOR","ADMIT","ADOPT","ADULT","AFTER","AGAIN","AGENT","AGREE","AHEAD","ALARM","ALBUM","ALERT","ALIEN","ALIGN","ALIKE","ALIVE","ALLOW","ALONE","ALONG","ALTAR","ALTER","AMONG","ANGEL","ANGLE","ANGRY","ANKLE","APART","APPLE","APPLY","ARENA","ARGUE","ARISE","ARMOR","AROMA","ARRAY","ARROW","ASSET","AUDIO","AVOID","AWARD","AWARE","AWFUL","BACON","BADGE","BADLY","BAKER","BASIC","BASIN","BASIS","BATCH","BEACH","BEAST","BEGAN","BEGIN","BEING","BELOW","BENCH","BERRY","BIBLE","BIRTH","BLACK","BLADE","BLAME","BLANK","BLAST","BLEND","BLESS","BLIND","BLOCK","BLOOD","BLOOM","BLOWN","BOARD","BOAST","BONUS","BOOTH","BRAIN","BRAKE","BRAND","BRASS","BRAVE","BREAD","BREAK","BRICK","BRIDE","BRIEF","BRING","BROAD","BROKE","BROOK","BROWN","BRUSH","BUILD","BUNCH","BURNT","BURST","BUYER","CABIN","CABLE","CAMEL","CANDY","CARGO","CARRY","CARVE","CATCH","CAUSE","CHAIN","CHAIR","CHALK","CHAMP","CHARM","CHART","CHASE","CHEAP","CHECK","CHEEK","CHEER","CHESS","CHEST","CHILD","CHILL","CHINA","CHOIR","CHORD","CHOSE","CIGAR","CIRCA","CIVIL","CLAIM","CLASS","CLEAN","CLEAR","CLERK","CLICK","CLIFF","CLIMB","CLING","CLOCK","CLOSE","CLOTH","CLOUD","CLOWN","COACH","COAST","COLON","COLOR","CORAL","COUCH","COULD","COUNT","COURT","COVER","CRACK","CRAFT","CRANE","CRASH","CRAWL","CRAZY","CREAM","CREEK","CREST","CRIME","CRISP","CROSS","CROWD","CROWN","CRUDE","CRUEL","CRUSH","CUBIC","CURVE","CYBER","CYCLE","DAIRY","DANCE","DEALT","DEATH","DEBUT","DECAY","DELTA","DENSE","DEPOT","DEPTH","DERBY","DIARY","DIGIT","DIRTY","DISCO","DITCH","DOUBT","DOUGH","DOZEN","DRAFT","DRAIN","DRAMA","DRANK","DRAWL","DRAWN","DREAD","DREAM","DRESS","DRIED","DRIFT","DRILL","DRINK","DRIVE","DROWN","DYING","EAGER","EARLY","EARTH","EIGHT","ELBOW","ELDER","ELECT","ELITE","EMPTY","ENEMY","ENJOY","ENTER","ENTRY","EQUAL","EQUIP","ERROR","ESSAY","ETHIC","EVADE","EVENT","EVERY","EXACT","EXCEL","EXILE","EXIST","EXTRA","FAINT","FAIRY","FAITH","FALSE","FANCY","FATAL","FAULT","FAVOR","FEAST","FENCE","FERRY","FETCH","FEVER","FIBER","FIELD","FIFTY","FIGHT","FINAL","FIRST","FIXED","FLAME","FLASH","FLASK","FLEET","FLESH","FLOAT","FLOCK","FLOOD","FLOOR","FLORA","FLOUR","FLUID","FLUSH","FOCUS","FORCE","FORGE","FORTH","FORTY","FORUM","FOUND","FRAME","FRANK","FRAUD","FRESH","FRONT","FROST","FRUIT","FULLY","FUNNY","GHOST","GIANT","GIVEN","GLAND","GLASS","GLEAM","GLIDE","GLOBE","GLOOM","GLORY","GLOVE","GOOSE","GRACE","GRADE","GRAIN","GRAND","GRANT","GRAPE","GRAPH","GRASP","GRASS","GRAVE","GREED","GREEN","GREET","GRIEF","GRILL","GRIND","GROAN","GROOM","GROSS","GROUP","GROVE","GROWL","GROWN","GUARD","GUESS","GUEST","GUIDE","GUILD","GUILT","HABIT","HANDY","HAPPY","HARSH","HASTE","HAVEN","HEART","HEAVY","HEDGE","HELLO","HENCE","HERBS","HINGE","HOBBY","HONOR","HORSE","HOTEL","HOUND","HOUSE","HUMAN","HUMID","HUMOR","HURRY","IDEAL","IMAGE","IMPLY","INDEX","INNER","INPUT","INTEL","INTER","INTRO","IRONY","ISSUE","IVORY","JELLY","JEWEL","JOINT","JOKER","JUDGE","JUICE","JUICY","JUMBO","JUMPY","KIOSK","KNIFE","KNOCK","LABEL","LABOR","LARGE","LASER","LATER","LAUGH","LAYER","LEARN","LEASE","LEAST","LEAVE","LEGAL","LEMON","LEVEL","LEVER","LIGHT","LIMIT","LINEN","LINER","LIVER","LOBBY","LOCAL","LODGE","LOGIC","LOOSE","LORRY","LOTUS","LOUSY","LOVER","LOWER","LOYAL","LUCKY","LUNAR","LUNCH","MAGIC","MAGMA","MAJOR","MAKER","MANOR","MARCH","MARRY","MARSH","MATCH","MAYOR","MEDAL","MEDIA","MELON","MERCY","MERGE","MERIT","MERRY","METAL","METER","MICRO","MIDST","MIGHT","MINOR","MINUS","MIRTH","MIXER","MODEL","MODEM","MONEY","MONTH","MORAL","MOTOR","MOUND","MOUNT","MOUSE","MOUTH","MOVIE","MUDDY","MUSIC","NAIVE","NAKED","NASTY","NAVAL","NERVE","NEVER","NIGHT","NINTH","NOBLE","NOISE","NORTH","NOTCH","NOTED","NOVEL","NURSE","OCCUR","OCEAN","OFFER","OFTEN","OLIVE","OMEGA","ONION","ONSET","OPERA","ORBIT","ORDER","ORGAN","OTHER","OUGHT","OUTER","OWNED","OWNER","OXIDE","OZONE","PAINT","PANEL","PANIC","PAPER","PARTY","PASTA","PATCH","PAUSE","PEACE","PEACH","PEARL","PEDAL","PENNY","PERCH","PHASE","PHONE","PHOTO","PIANO","PIECE","PILOT","PINCH","PITCH","PIXEL","PIZZA","PLACE","PLAIN","PLANE","PLANT","PLATE","PLAZA","PLEAD","PLUCK","PLUMB","PLUMP","PLUNGE","POINT","POLAR","PORCH","POUCH","POUND","POWER","PRESS","PRICE","PRIDE","PRIME","PRINT","PRIOR","PRIZE","PROBE","PRONE","PROOF","PROUD","PROVE","PROXY","PUNCH","PUPIL","PUPPY","PURSE","QUAKE","QUEEN","QUERY","QUEST","QUICK","QUIET","QUITE","QUOTA","QUOTE","RADAR","RADIO","RAISE","RALLY","RANCH","RANGE","RAPID","RATIO","REACH","REACT","READY","REALM","REBEL","REFER","REIGN","RELAX","RELAY","RELY","REPLY","RESET","RIDER","RIDGE","RIFLE","RIGHT","RIGID","RIPEN","RISEN","RISKY","RIVAL","RIVER","ROAST","ROBOT","ROCKY","ROMAN","ROUGH","ROUND","ROUTE","ROYAL","RUGBY","RULER","RUMOR","RURAL","SAFER","SAINT","SALAD","SALON","SANDY","SAUCE","SAUNA","SCALE","SCARE","SCARF","SCARY","SCENE","SCENT","SCOPE","SCORE","SCOUT","SCRAP","SEIZE","SERVE","SETUP","SEVEN","SHADE","SHAKE","SHALL","SHAME","SHAPE","SHARE","SHARK","SHARP","SHAVE","SHEEP","SHEER","SHEET","SHELF","SHELL","SHIFT","SHINE","SHINY","SHIRT","SHOCK","SHORE","SHORT","SHOUT","SHOWN","SHRUG","SIGHT","SIGMA","SILKY","SILLY","SINCE","SIXTY","SIZED","SKILL","SKULL","SLAVE","SLEEP","SLICE","SLIDE","SLOPE","SMALL","SMART","SMELL","SMILE","SMOKE","SNAKE","SNOWY","SOBER","SOLID","SOLVE","SONIC","SORRY","SOUND","SOUTH","SPACE","SPARE","SPARK","SPEAK","SPEAR","SPEED","SPELL","SPEND","SPICE","SPICY","SPIKE","SPILL","SPINE","SPOIL","SPOKE","SPOON","SPORT","SPRAY","SQUAD","STACK","STAFF","STAGE","STAIN","STAIR","STAKE","STALE","STAMP","STAND","STARK","START","STATE","STEAK","STEAL","STEAM","STEEL","STEEP","STEER","STICK","STIFF","STILL","STOCK","STONE","STOOL","STORE","STORM","STORY","STOVE","STRAP","STRAW","STRIP","STUCK","STUDY","STUFF","STUNT","STYLE","SUGAR","SUITE","SUNNY","SUPER","SURGE","SWAMP","SWEAR","SWEAT","SWEET","SWEPT","SWIFT","SWING","SWORD","TABLE","TAKEN","TASTE","TASTY","TEACH","TEMPO","TENSE","TENTH","TERMS","THANK","THEME","THICK","THIEF","THING","THINK","THIRD","THORN","THOSE","THREE","THREW","THROW","THUMB","TIGER","TIGHT","TIMER","TIRED","TITLE","TOAST","TODAY","TOKEN","TONIC","TOOTH","TOPIC","TORCH","TOTAL","TOUCH","TOUGH","TOWER","TOXIC","TRACE","TRACK","TRADE","TRAIL","TRAIN","TRAIT","TRASH","TREAT","TREND","TRIAL","TRIBE","TRICK","TRIED","TROOP","TRUCK","TRULY","TRUMP","TRUNK","TRUST","TRUTH","TUMOR","TUNER","TWICE","TWIST","ULTRA","UNCLE","UNDER","UNFAIR","UNION","UNITE","UNITY","UNTIL","UPPER","UPSET","URBAN","USAGE","USUAL","VALID","VALUE","VALVE","VAULT","VENUE","VIDEO","VIGOR","VIRAL","VIRUS","VISIT","VITAL","VIVID","VOCAL","VOICE","VOTER","WAGON","WAIST","WASTE","WATCH","WATER","WEARY","WEIGH","WEIRD","WHALE","WHEAT","WHEEL","WHERE","WHICH","WHILE","WHITE","WHOLE","WHOSE","WIDER","WIDOW","WIDTH","WIPER","WITCH","WOMAN","WOODS","WORLD","WORMS","WORRY","WORSE","WORST","WORTH","WOULD","WOUND","WRIST","WRITE","WRONG","WROTE","YACHT","YIELD","YOUNG","YOURS","YOUTH","ZEBRA","ZONAL"],Jt={3:zt,4:Vt,5:$t};function it(a){return Jt[a]}function nt(a,t){const e=new Set(t.map(s=>s.toUpperCase()));return a.filter(s=>s.split("").every(i=>e.has(i)))}function Xt(a,t){const e=a.toUpperCase().split(""),s=N();return e.reduce((n,r)=>{const c=t[r]?.wma??s;return n+c},0)/e.length}function qt(a,t,e,s=50,i=null){const n=it(a),r=nt(n,e);if(r.length===0)throw new Error("No valid words available with current character set");if(r.length===1)return r[0];const c=r.map(u=>{const g=Xt(u,t),S=s/50;let A=Math.pow(g/1e3,S);return u===i&&(A*=.2),{word:u,weight:A}}),l=c.reduce((u,g)=>u+g.weight,0),h=Math.random()*l;let d=0;for(const{word:u,weight:g}of c)if(d+=g,h<=d)return u;return c[c.length-1].word}function mt(a,t){const e=it(a);return nt(e,t).length>0}function _t(a,t){const e=it(a);return nt(e,t).length}class jt{charModeBtn;wordModeBtn;callsignModeBtn;wordLengthControl;wordLengthSlider;wordLengthValue;wordCountInfo;callsignFormatControl;callsignFormatInfo;formatCheckboxes;onModeChange=null;onChartToggle=null;constructor(){this.charModeBtn=document.getElementById("char-mode-btn"),this.wordModeBtn=document.getElementById("word-mode-btn"),this.callsignModeBtn=document.getElementById("callsign-mode-btn"),this.wordLengthControl=document.getElementById("word-length-control"),this.wordLengthSlider=document.getElementById("word-length-slider"),this.wordLengthValue=document.getElementById("word-length-value"),this.wordCountInfo=document.getElementById("word-count-info"),this.callsignFormatControl=document.getElementById("callsign-format-control"),this.callsignFormatInfo=document.getElementById("callsign-format-info"),this.formatCheckboxes=document.querySelectorAll('.format-checkbox input[type="checkbox"]'),this.setupEventListeners(),this.initializeFromState()}setupEventListeners(){this.charModeBtn.addEventListener("click",()=>this.setMode("character")),this.wordModeBtn.addEventListener("click",()=>this.setMode("word")),this.callsignModeBtn.addEventListener("click",()=>this.setMode("callsign")),this.wordLengthSlider.addEventListener("input",()=>{const t=parseInt(this.wordLengthSlider.value);this.wordLengthValue.textContent=t.toString(),o.updateWordModeSettings({wordLength:t}),this.updateWordCountInfo(t),this.onModeChange&&this.onModeChange("word")}),this.formatCheckboxes.forEach(t=>{t.addEventListener("change",()=>{this.updateCallsignFormats(),this.onModeChange&&this.onModeChange("callsign")})}),o.subscribe("characterSet",()=>{const t=o.getWordModeSettings();t.practiceMode==="word"&&this.updateWordCountInfo(t.wordLength)})}initializeFromState(){const t=o.getWordModeSettings(),e=o.getCallsignModeSettings();this.formatCheckboxes.forEach(s=>{s.checked=e.enabledFormats.includes(s.value)}),this.updateUI(t.practiceMode,t.wordLength),this.updateCallsignFormatInfo()}setMode(t){o.updateWordModeSettings({practiceMode:t}),this.updateUI(t,o.getWordModeSettings().wordLength),this.onModeChange&&this.onModeChange(t),this.onChartToggle&&this.onChartToggle(t)}updateUI(t,e){this.charModeBtn.classList.toggle("active",t==="character"),this.wordModeBtn.classList.toggle("active",t==="word"),this.callsignModeBtn.classList.toggle("active",t==="callsign"),this.wordLengthControl.classList.toggle("hidden",t!=="word"),this.callsignFormatControl.classList.toggle("hidden",t!=="callsign"),this.wordLengthSlider.value=e.toString(),this.wordLengthValue.textContent=e.toString(),t==="word"&&this.updateWordCountInfo(e),t==="callsign"&&this.updateCallsignFormatInfo()}updateWordCountInfo(t){const e=o.getActiveCharacters(),s=_t(t,e);mt(t,e)?(this.wordCountInfo.textContent=`${s} words available`,this.wordCountInfo.classList.remove("warning")):(this.wordCountInfo.textContent="No words available with current character set",this.wordCountInfo.classList.add("warning"))}updateCallsignFormats(){const t=[];this.formatCheckboxes.forEach(e=>{e.checked&&t.push(e.value)}),o.updateCallsignModeSettings({enabledFormats:t}),this.updateCallsignFormatInfo()}updateCallsignFormatInfo(){const t=o.getCallsignModeSettings(),e=t.enabledFormats.length;if(e===0)this.callsignFormatInfo.textContent="Select at least one format",this.callsignFormatInfo.classList.add("warning");else{const s={"1x1":"K1A","1x2":"W3AB","2x1":"KA5X","2x2":"WB2XY","1x3":"N7ABC","2x3":"KE9BOS"},i=t.enabledFormats.slice(0,3).map(r=>s[r]).join(", "),n=e>3?"...":"";this.callsignFormatInfo.textContent=`e.g., ${i}${n}`,this.callsignFormatInfo.classList.remove("warning")}}setOnModeChange(t){this.onModeChange=t}setOnChartToggle(t){this.onChartToggle=t}getCurrentMode(){return o.getWordModeSettings().practiceMode}getCurrentWordLength(){return o.getWordModeSettings().wordLength}}function Zt(a,t,e=50,s=null){if(a.length===0)throw new Error("No active characters to select from");if(a.length===1)return a[0];const i=N(),n=a.map(h=>{const d=t[h]?.wma??i,u=e/50;let g=Math.pow(d/1e3,u);return h===s&&(g*=.2),{char:h,weight:g}}),r=n.reduce((h,d)=>h+d.weight,0),c=Math.random()*r;let l=0;for(const{char:h,weight:d}of n)if(l+=d,c<=l)return h;return n[n.length-1].char}const ft=[{id:"1x1",name:"1Ã—1 (e.g., K1A)",prefixLength:1,suffixLength:1},{id:"1x2",name:"1Ã—2 (e.g., W3AB)",prefixLength:1,suffixLength:2},{id:"2x1",name:"2Ã—1 (e.g., KA5X)",prefixLength:2,suffixLength:1},{id:"2x2",name:"2Ã—2 (e.g., WB2XY)",prefixLength:2,suffixLength:2},{id:"1x3",name:"1Ã—3 (e.g., N7ABC)",prefixLength:1,suffixLength:3},{id:"2x3",name:"2Ã—3 (e.g., KE9BOS)",prefixLength:2,suffixLength:3}],lt=["K","N","W","A"],ht="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),dt="0123456789".split("");function Qt(a){return ft.filter(t=>a.includes(t.id))}function K(a,t,e){if(a.length===0)throw new Error("No candidates for weighted selection");if(a.length===1||e===0)return a[Math.floor(Math.random()*a.length)];const s=N(),i=e/50,n=a.map(h=>{const d=t[h]?.wma??s,u=Math.pow(d/1e3,i);return{char:h,weight:u}}),r=n.reduce((h,d)=>h+d.weight,0),c=Math.random()*r;let l=0;for(const{char:h,weight:d}of n)if(l+=d,c<=l)return h;return n[n.length-1].char}function ut(a,t,e,s){const i=ht.filter(u=>e.includes(u)),n=dt.filter(u=>e.includes(u)),r=i.length>0?i:ht,c=n.length>0?n:dt,l=lt.filter(u=>r.includes(u)),h=l.length>0?l:lt;let d="";d+=K(h,t,s),a.prefixLength===2&&(d+=K(r,t,s)),d+=K(c,t,s);for(let u=0;u<a.suffixLength;u++)d+=K(r,t,s);return d}function te(a){const t=Qt(a);return t.length===0?ft.find(e=>e.id==="2x3"):t[Math.floor(Math.random()*t.length)]}function ee(a,t,e,s,i=null){const n=te(a);let r=ut(n,t,e,s),c=0;for(;r===i&&c<3;)r=ut(n,t,e,s),c++;return r}const gt={zero:"0",one:"1",two:"2",three:"3",four:"4",five:"5",six:"6",seven:"7",eight:"8",nine:"9",niner:"9",tree:"3",fower:"4",fife:"5",oh:"0",o:"0",won:"1",wun:"1",to:"2",too:"2",free:"3",for:"4",ate:"8",ait:"8"};function se(a){const t=a.toLowerCase().trim();if(!t)return"?";if(gt[t])return gt[t];if(/^[0-9]$/.test(t))return t;const e=t.match(/^([0-9])(st|nd|rd|th)$/i);if(e)return e[1];if(/^[a-z]$/i.test(t))return t.toUpperCase();const s=t.charAt(0);return/[a-z]/i.test(s)?s.toUpperCase():"?"}function ie(a){return a.trim().split(/\s+/).filter(e=>e.length>0).map(se).join("")}function ne(a,t){const e=ie(t),s=a.toUpperCase(),i=[],n=Math.max(s.length,e.length);for(let r=0;r<n;r++){const c=s[r]||"",l=e[r]||"";c!==l&&i.push({position:r,expected:c||"(missing)",got:l||"(missing)"})}return{isCorrect:i.length===0&&e.length===s.length,expected:s,parsed:e,errors:i}}function re(a){if(a.isCorrect)return"Correct!";if(a.parsed.length===0)return"No response detected";if(a.parsed.length!==a.expected.length)return`Expected ${a.expected.length} characters, got ${a.parsed.length}`;if(a.errors.length===1){const t=a.errors[0];return`Position ${t.position+1}: expected "${t.expected}", heard "${t.got}"`}return`${a.errors.length} errors: ${a.errors.map(t=>`"${t.got}" should be "${t.expected}"`).join(", ")}`}const oe=600*1e3,B=800,Et=6e3,At=4e3,tt=1200;class ae{audioContext=null;analyser=null;mediaStream=null;animationId=null;levelBar=null;container=null;isRunning=!1;constructor(){this.container=document.getElementById("practice-level-container"),this.levelBar=document.getElementById("practice-level")}async start(){if(this.isRunning)return!0;try{return this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0}}),this.audioContext=new AudioContext,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.audioContext.createMediaStreamSource(this.mediaStream).connect(this.analyser),this.isRunning=!0,this.show(),this.updateLevel(),!0}catch(t){return console.error("Failed to start audio level monitor:",t),!1}}stop(){this.isRunning=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>t.stop()),this.mediaStream=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser=null,this.hide()}show(){this.container?.classList.remove("hidden")}hide(){this.container?.classList.add("hidden"),this.levelBar&&(this.levelBar.style.width="0%")}updateLevel(){if(!this.analyser||!this.isRunning)return;const t=new Uint8Array(this.analyser.frequencyBinCount);this.analyser.getByteFrequencyData(t);const e=t.reduce((i,n)=>i+n,0)/t.length,s=Math.min(100,e/128*100);this.levelBar&&(this.levelBar.style.width=`${s}%`,this.levelBar.classList.remove("low","medium","high"),s<20?this.levelBar.classList.add("low"):s<50?this.levelBar.classList.add("medium"):this.levelBar.classList.add("high")),this.animationId=requestAnimationFrame(()=>this.updateLevel())}}class ce{recognizer=null;previousChar=null;previousWord=null;previousCallsign=null;currentWord=null;currentCallsign=null;audioPlayedAt=0;breakCheckInterval=null;nextCharTimeout=null;isPlayingChar=!1;useContinuousMode=!1;justRestartedRecognition=!1;lastWrongAnswer=null;lastAttempt=null;repeatAttempts=0;audioLevelMonitor;startBtn;currentCharEl;feedbackTextEl;listeningIndicator;breakModal;debugHeardEl;acceptAnswerBtn;recoveryBtn;constructor(){this.startBtn=document.getElementById("start-btn"),this.currentCharEl=document.getElementById("current-char"),this.feedbackTextEl=document.getElementById("feedback-text"),this.listeningIndicator=document.getElementById("listening-indicator"),this.breakModal=document.getElementById("break-modal"),this.debugHeardEl=document.getElementById("debug-heard"),this.acceptAnswerBtn=document.getElementById("accept-answer-btn"),this.recoveryBtn=document.getElementById("recovery-btn"),this.audioLevelMonitor=new ae,this.setupEventListeners(),this.initializeSpeechRecognition()}setupEventListeners(){this.startBtn.addEventListener("click",()=>this.toggleSession()),this.acceptAnswerBtn?.addEventListener("click",()=>this.handleAcceptAnswer()),this.recoveryBtn?.addEventListener("click",()=>this.handleRecovery()),document.getElementById("dismiss-break")?.addEventListener("click",()=>{this.breakModal.classList.add("hidden"),o.updateSession({lastBreakReminder:Date.now()})}),o.subscribe("session",e=>{e.isRunning?(this.startBtn.textContent="Pause",this.startBtn.classList.add("running"),this.recoveryBtn?.classList.remove("hidden")):(this.startBtn.textContent="Start",this.startBtn.classList.remove("running"),this.listeningIndicator.classList.add("hidden"),this.hideAcceptButton(),this.recoveryBtn?.classList.add("hidden"))})}showAcceptButton(){this.acceptAnswerBtn?.classList.remove("hidden")}hideAcceptButton(){this.acceptAnswerBtn?.classList.add("hidden"),this.lastWrongAnswer=null}handleRecovery(){if(o.getSession().isRunning){if(console.log("Recovery triggered - will stop then restart session"),this.lastAttempt){const{type:e,chars:s,wasCorrect:i,previousWMAs:n}=this.lastAttempt;if(e==="character"&&s.length===1){const c=n[s[0]];c&&o.revertCharacterAttempt(s[0],i,c.wma,c.mostRecent)}else e==="word"?o.revertWordCharacterAttempts(s,i,n):e==="callsign"&&o.revertCallsignCharacterAttempts(s,i,n);const r=o.getSession().totalCharsThisSession;r>0&&o.updateSession({totalCharsThisSession:r-1}),console.log("Last attempt reverted"),this.lastAttempt=null}this.stop(),this.feedbackTextEl.textContent="Restarting in 3 seconds...",setTimeout(async()=>{o.getSession().isRunning||(this.feedbackTextEl.textContent="Restarting...",await this.start())},3e3)}}getSimilarSoundingWords(t){const e=t.toUpperCase(),s=[["TEN","TAN","TIN","TON","TUN"],["PEN","PAN","PIN","PUN"],["BET","BAT","BIT","BUT","BOT"],["SET","SAT","SIT"],["MEN","MAN","MIN"],["NET","NAT","NIT","NUT","NOT"],["PET","PAT","PIT","PUT","POT"],["BED","BAD","BID","BUD"],["RED","RAD","RID","ROD"],["LED","LAD","LID"],["WET","WAT","WIT"],["HEN","HAN"],["DEN","DAN","DIN","DON","DUN"],["RUN","RAN"],["SUN","SON"],["WON","ONE","WIN"],["FUN","FAN","FIN"],["GUN","GAN"],["CAN","CON","KIN"],["CAP","COP","CUP"],["MAP","MOP","MIP"],["TAP","TIP","TOP"],["RAP","RIP","REP"],["LAP","LIP","LOP"],["SAP","SIP","SUP","SOP"],["HAP","HIP","HOP"],["DAM","DIM","DUM"],["HAM","HIM","HUM"],["JAM","JIM"],["RAM","RIM","RUM"],["CAT","COT","CUT"],["HAT","HIT","HOT","HUT"],["RAT","RUT","ROT"],["MAT","MIT","MUT"],["FOR","FUR","FAR"],["BAR","BUR"],["CAR","CUR"],["TAR","TOR"]];for(const i of s)if(i.includes(e))return i;return[e]}handleAcceptAnswer(){if(!this.lastWrongAnswer)return;const{expected:t,heard:e,responseTime:s,isWordMode:i}=this.lastWrongAnswer;if(i){const r=this.getSimilarSoundingWords(t);for(const l of r)o.addPronunciationAlias(l,e,!0);const c=r.length;this.feedbackTextEl.textContent=c>1?`Saved! "${e}" accepted for ${c} similar words`:`Saved! "${e}" now accepted for "${t}"`}else o.addPronunciationAlias(t,e,!1),this.feedbackTextEl.textContent=`Saved! "${e}" now accepted for "${t}"`;this.acceptAnswerBtn.classList.add("saving"),this.currentCharEl.className="current-char correct";const n=o.getSettings();if(k(n.volume*.6),i){const r=s/t.length;for(const c of t.toUpperCase()){const l=o.getWordCharacterHistory(c),h=b(l.wma,r,!0);o.updateWordCharacterHistory(c,{wma:h,mostRecent:r,totalAttempts:l.totalAttempts,correctAttempts:l.correctAttempts+1,lastPracticed:Date.now()})}}else{const r=o.getCharacterHistory(t),c=b(r.wma,s,!0);o.updateCharacterHistory(t,{wma:c,mostRecent:s,totalAttempts:r.totalAttempts,correctAttempts:r.correctAttempts+1,lastPracticed:Date.now()})}this.lastWrongAnswer=null,setTimeout(()=>{this.acceptAnswerBtn.classList.remove("saving"),this.hideAcceptButton()},500)}pauseRecognition(){this.recognizer&&(this.useContinuousMode?this.recognizer.ignoreResults():this.recognizer.stop())}initializeSpeechRecognition(){if(!y()){this.feedbackTextEl.textContent="Speech recognition not supported",this.startBtn.disabled=!0;return}const t=new I;($()||T())&&(this.useContinuousMode=!0,t.setContinuousMode(!0),console.log("Mobile detected: using continuous speech recognition mode")),this.recognizer=t,this.setupRecognizerCallbacks()}setupRecognizerCallbacks(){this.recognizer&&(this.recognizer.onResult(t=>{this.handleRecognitionResult(t.transcript,t.rawTranscript,t.timestamp)}),this.recognizer.onRaw((t,e)=>{this.debugHeardEl&&(e?(this.debugHeardEl.textContent=`Heard: "${t}" â†’ ${e}`,this.debugHeardEl.style.color="#00d26a"):(this.debugHeardEl.textContent=`Heard: "${t}" â†’ (not recognized)`,this.debugHeardEl.style.color="#ff4757"))}),this.recognizer.onError(t=>{t==="not-allowed"?(this.feedbackTextEl.textContent="Microphone access denied. Please allow microphone access.",this.stop()):t==="network"&&(this.feedbackTextEl.textContent="Network error. Check your connection.")}),"onEnd"in this.recognizer&&!T()&&this.recognizer.onEnd(()=>{o.getSession().isRunning&&!this.isPlayingChar&&(console.log("Recognition ended unexpectedly, restarting..."),setTimeout(()=>{o.getSession().isRunning&&this.recognizer&&!this.isPlayingChar&&(o.getWordModeSettings().practiceMode==="callsign"&&this.currentCallsign&&this.recognizer instanceof I&&this.recognizer.setCallsignMode(!0,this.currentCallsign.length),this.recognizer.start())},100))}))}async toggleSession(){o.getSession().isRunning?this.stop():await this.start()}async start(){if(await H(),T()||await this.audioLevelMonitor.start(),this.lastAttempt=null,o.startSession(),this.breakCheckInterval=window.setInterval(()=>{this.checkBreakReminder()},6e4),this.useContinuousMode&&this.recognizer&&this.recognizer instanceof I){console.log("Starting continuous recognition for session"),this.recognizer.start(),this.recognizer.ignoreResults();const t=T()?3500:3e3;if(this.feedbackTextEl.textContent="Starting microphone...",await new Promise(e=>setTimeout(e,t)),!o.getSession().isRunning)return}this.playNextCharacter()}stop(){o.stopSession(),st(),this.isPlayingChar=!1,this.nextCharTimeout&&(clearTimeout(this.nextCharTimeout),this.nextCharTimeout=null),this.recognizer&&this.recognizer.stop(),this.breakCheckInterval&&(clearInterval(this.breakCheckInterval),this.breakCheckInterval=null),this.audioLevelMonitor.stop(),this.lastAttempt=null,this.listeningIndicator.classList.add("hidden"),this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char",this.feedbackTextEl.textContent="Press Start to begin"}async playNextCharacter(){if(!o.getSession().isRunning||this.isPlayingChar)return;this.isPlayingChar=!0;const e=o.getActiveCharacters();if(e.length===0){this.feedbackTextEl.textContent="No characters selected",this.isPlayingChar=!1,this.stop();return}const s=o.getSettings(),i=o.getWordModeSettings();if(i.practiceMode==="word"){await this.playNextWord();return}if(i.practiceMode==="callsign"){await this.playNextCallsign();return}const n=o.getHistory(),r=Zt(e,n,s.adaptiveGain,this.previousChar);if(o.updateSession({currentChar:r}),this.previousChar=r,this.currentWord=null,this.repeatAttempts=0,this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char",this.feedbackTextEl.textContent="Listen...",this.listeningIndicator.classList.add("hidden"),this.recognizer&&this.recognizer.setExpectedChar(r),T()&&!this.useContinuousMode&&this.recognizer){if(console.log("Android: starting recognition before morse (chime will play)"),this.recognizer.start(),this.feedbackTextEl.textContent="Starting...",await new Promise(l=>setTimeout(l,2e3)),!o.getSession().isRunning){this.isPlayingChar=!1;return}this.feedbackTextEl.textContent="Listen..."}else this.pauseRecognition();const c=await ct(r,s.characterSpeed,s.toneFrequency,s.volume);if(!o.getSession().isRunning||!c){this.isPlayingChar=!1;return}if(this.audioPlayedAt=performance.now(),this.isPlayingChar=!1,this.feedbackTextEl.textContent="Speak the character",this.listeningIndicator.classList.remove("hidden"),this.recognizer)if(this.useContinuousMode){const l=this.justRestartedRecognition?2e3:100;this.justRestartedRecognition&&(console.log("Post-restart: waiting extra time for WebKit to be ready"),this.justRestartedRecognition=!1),await new Promise(h=>setTimeout(h,l)),this.audioPlayedAt=performance.now(),this.recognizer.acceptResults()}else T()||this.recognizer.start()}async playNextWord(){if(!o.getSession().isRunning)return;const e=o.getActiveCharacters(),s=o.getSettings(),i=o.getWordModeSettings(),n=o.getWordHistory(),r=i.wordLength;if(!mt(r,e)){this.feedbackTextEl.textContent="No words available with current character set",this.isPlayingChar=!1,this.stop();return}const c=qt(r,n,e,s.adaptiveGain,this.previousWord);if(this.currentWord=c,this.previousWord=c,o.updateSession({currentChar:c}),this.repeatAttempts=0,this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char",this.feedbackTextEl.textContent="Listen...",this.listeningIndicator.classList.add("hidden"),this.recognizer&&this.recognizer.setExpectedChar(null),T()&&!this.useContinuousMode&&this.recognizer){if(console.log("Android: starting recognition before morse word (chime will play)"),this.recognizer.start(),this.feedbackTextEl.textContent="Starting...",await new Promise(h=>setTimeout(h,2e3)),!o.getSession().isRunning){this.isPlayingChar=!1;return}this.feedbackTextEl.textContent="Listen..."}else this.recognizer&&(this.useContinuousMode?this.recognizer.ignoreResults():this.recognizer.stop());const l=await G(c,s.characterSpeed,s.toneFrequency,s.volume);if(!o.getSession().isRunning||!l){this.isPlayingChar=!1;return}this.audioPlayedAt=performance.now(),this.isPlayingChar=!1,this.feedbackTextEl.textContent="Speak the word",this.listeningIndicator.classList.remove("hidden"),this.recognizer&&(this.useContinuousMode?(await new Promise(h=>setTimeout(h,100)),this.audioPlayedAt=performance.now(),this.recognizer.acceptResults()):T()||this.recognizer.start())}async replayCurrentCharacter(){const t=o.getSession();if(!t.isRunning||!t.currentChar||this.isPlayingChar)return;this.isPlayingChar=!0;const e=o.getSettings();if(this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char",this.feedbackTextEl.textContent="Listen...",this.listeningIndicator.classList.add("hidden"),this.recognizer&&this.recognizer.setExpectedChar(t.currentChar),T()&&!this.useContinuousMode&&this.recognizer){if(console.log("Android: starting recognition before morse replay (chime will play)"),this.recognizer.start(),this.feedbackTextEl.textContent="Starting...",await new Promise(i=>setTimeout(i,2e3)),!o.getSession().isRunning){this.isPlayingChar=!1;return}this.feedbackTextEl.textContent="Listen..."}else this.recognizer&&(this.useContinuousMode?this.recognizer.ignoreResults():this.recognizer.stop());const s=await ct(t.currentChar,e.characterSpeed,e.toneFrequency,e.volume);if(!o.getSession().isRunning||!s){this.isPlayingChar=!1;return}this.audioPlayedAt=performance.now(),this.isPlayingChar=!1,this.feedbackTextEl.textContent="Speak the character",this.listeningIndicator.classList.remove("hidden"),this.recognizer&&(this.useContinuousMode?(await new Promise(i=>setTimeout(i,100)),this.audioPlayedAt=performance.now(),this.recognizer.acceptResults()):T()||this.recognizer.start())}handleRecognitionResult(t,e,s){const i=o.getSession();if(!i.isRunning||!i.currentChar)return;const n=o.getWordModeSettings();if(n.practiceMode==="word"&&this.currentWord){this.handleWordRecognitionResult(e,s);return}if(n.practiceMode==="callsign"&&this.currentCallsign){this.handleCallsignRecognitionResult(e,s);return}this.recognizer&&(this.useContinuousMode&&this.recognizer instanceof I?this.recognizer.ignoreResults():this.recognizer.stop()),this.listeningIndicator.classList.add("hidden"),this.hideAcceptButton();const r=s-this.audioPlayedAt,c=Math.max(100,r-tt),l=t.toUpperCase()===i.currentChar.toUpperCase(),h=o.matchesAlias(i.currentChar,e,!1),d=l||h,u=D(i.currentChar);this.currentCharEl.textContent=u,this.currentCharEl.className=`current-char ${d?"correct":"incorrect"}`;const g=o.getSettings();if(d?k(g.volume*.6):Q(g.volume*.6),d){if(this.feedbackTextEl.textContent=`Correct! ${Math.round(c)}ms`,this.debugHeardEl){const O=h&&!l?" (alias)":"";this.debugHeardEl.textContent=`Heard: "${e}"${O} | adjusted: ${Math.round(c)}ms | raw: ${Math.round(r)}ms`,this.debugHeardEl.style.color="#00d26a"}}else{const O=t.startsWith("[unrecognized:");this.repeatAttempts++;const M=g.maxRepeatTries,P=M<6&&this.repeatAttempts>=M;if(g.repeatUntilCorrect&&!P)this.feedbackTextEl.textContent="Incorrect - try again",this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char incorrect";else if(P)this.feedbackTextEl.textContent=`Max tries reached - was "${u}"`;else if(O)this.feedbackTextEl.textContent=`"${e}" not recognized - was "${u}"`;else{const p=D(t);this.feedbackTextEl.textContent=`You said "${p}" - was "${u}"`}}const S=o.getCharacterHistory(i.currentChar);this.lastAttempt={type:"character",value:i.currentChar,chars:[i.currentChar],wasCorrect:d,previousWMAs:{[i.currentChar]:{wma:S.wma,mostRecent:S.mostRecent}}};const A=b(S.wma,c,d);o.updateCharacterHistory(i.currentChar,{wma:A,mostRecent:d?c:z(S.wma),totalAttempts:S.totalAttempts+1,correctAttempts:S.correctAttempts+(d?1:0),lastPracticed:Date.now()}),o.updateSession({totalCharsThisSession:i.totalCharsThisSession+1}),this.nextCharTimeout&&clearTimeout(this.nextCharTimeout);const C=g.maxRepeatTries;!d&&g.repeatUntilCorrect&&(C>=6||this.repeatAttempts<C)?this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,o.getSession().isRunning&&this.replayCurrentCharacter()},B):d?this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,o.getSession().isRunning&&this.playNextCharacter()},B):this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,o.getSession().isRunning&&this.playNextCharacter()},B)}handleWordRecognitionResult(t,e){const s=o.getSession();if(!s.isRunning||!this.currentWord)return;this.recognizer&&(this.useContinuousMode&&this.recognizer instanceof I?this.recognizer.ignoreResults():this.recognizer.stop()),this.listeningIndicator.classList.add("hidden"),this.hideAcceptButton();const i=e-this.audioPlayedAt,n=Math.max(100,i-tt),c=t.toUpperCase().trim().replace(/[^A-Z]/g,"")||t.toUpperCase().trim(),l=this.currentWord.toUpperCase(),d={1:["ONE","WON"],2:["TWO","TOO"],4:["FOUR","FOR"],8:["ATE"],10:["TEN","TAN","TIN","TON","TUN"]}[c]||[c],u=c===l||d.includes(l),g=o.matchesAlias(l,t,!0),S=u||g;this.currentCharEl.textContent=l,this.currentCharEl.className=`current-char ${S?"correct":"incorrect"}`;const A=o.getSettings();if(S?k(A.volume*.6):Q(A.volume*.6),S){if(this.feedbackTextEl.textContent=`Correct! ${Math.round(n)}ms`,this.debugHeardEl){const p=d.includes(l)&&c!==l,m=g&&!u?" (alias)":p?" (number)":"";this.debugHeardEl.textContent=`Heard: "${t}"${m} | adjusted: ${Math.round(n)}ms`,this.debugHeardEl.style.color="#00d26a"}}else{this.repeatAttempts++;const p=A.maxRepeatTries,m=p<6&&this.repeatAttempts>=p;A.repeatUntilCorrect&&!m?(this.feedbackTextEl.textContent="Incorrect - try again",this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char incorrect"):m?this.feedbackTextEl.textContent=`Max tries reached - was "${l}"`:this.feedbackTextEl.textContent=`You said "${t}" - was "${l}"`,this.lastWrongAnswer={expected:l,heard:t,responseTime:n,isWordMode:!0},this.showAcceptButton()}const C=l.split(""),f={};for(const p of C){const m=o.getWordCharacterHistory(p);f[p]={wma:m.wma,mostRecent:m.mostRecent}}this.lastAttempt={type:"word",value:l,chars:C,wasCorrect:S,previousWMAs:f};const O=n/l.length;for(const p of l){const m=o.getWordCharacterHistory(p),W=b(m.wma,O,S);o.updateWordCharacterHistory(p,{wma:W,mostRecent:S?O:z(m.wma),totalAttempts:m.totalAttempts+1,correctAttempts:m.correctAttempts+(S?1:0),lastPracticed:Date.now()})}o.updateSession({totalCharsThisSession:s.totalCharsThisSession+1}),this.nextCharTimeout&&clearTimeout(this.nextCharTimeout);const M=A.maxRepeatTries;!S&&A.repeatUntilCorrect&&(M>=6||this.repeatAttempts<M)?this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,this.hideAcceptButton(),o.getSession().isRunning&&this.replayCurrentWord()},Et):S?this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,o.getSession().isRunning&&this.playNextCharacter()},B):this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,this.hideAcceptButton(),o.getSession().isRunning&&this.playNextCharacter()},Et)}async replayCurrentWord(){if(!o.getSession().isRunning||!this.currentWord||this.isPlayingChar)return;this.isPlayingChar=!0;const e=o.getSettings();if(this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char",this.feedbackTextEl.textContent="Listen...",this.listeningIndicator.classList.add("hidden"),this.recognizer&&this.recognizer.setExpectedChar(null),T()&&!this.useContinuousMode&&this.recognizer){if(console.log("Android: starting recognition before morse word replay (chime will play)"),this.recognizer.start(),this.feedbackTextEl.textContent="Starting...",await new Promise(i=>setTimeout(i,2e3)),!o.getSession().isRunning){this.isPlayingChar=!1;return}this.feedbackTextEl.textContent="Listen..."}else this.recognizer&&(this.useContinuousMode?this.recognizer.ignoreResults():this.recognizer.stop());const s=await G(this.currentWord,e.characterSpeed,e.toneFrequency,e.volume);if(!o.getSession().isRunning||!s){this.isPlayingChar=!1;return}this.audioPlayedAt=performance.now(),this.isPlayingChar=!1,this.feedbackTextEl.textContent="Speak the word",this.listeningIndicator.classList.remove("hidden"),this.recognizer&&(this.useContinuousMode?(await new Promise(i=>setTimeout(i,100)),this.audioPlayedAt=performance.now(),this.recognizer.acceptResults()):T()||this.recognizer.start())}async playNextCallsign(){if(!o.getSession().isRunning)return;const e=o.getActiveCharacters(),s=o.getSettings(),i=o.getCallsignModeSettings(),n=o.getCallsignHistory();if(i.enabledFormats.length===0){this.feedbackTextEl.textContent="No callsign formats selected",this.isPlayingChar=!1,this.stop();return}const r=ee(i.enabledFormats,n,e,s.adaptiveGain,this.previousCallsign);if(this.currentCallsign=r,this.previousCallsign=r,this.currentWord=null,o.updateSession({currentChar:r}),this.repeatAttempts=0,this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char",this.feedbackTextEl.textContent="Listen...",this.listeningIndicator.classList.add("hidden"),this.recognizer&&(this.recognizer.setExpectedChar(null),this.recognizer instanceof I&&this.recognizer.setCallsignMode(!0,r.length)),T()&&!this.useContinuousMode&&this.recognizer){if(console.log("Android: starting recognition before morse callsign (chime will play)"),this.recognizer.start(),this.feedbackTextEl.textContent="Starting...",await new Promise(l=>setTimeout(l,2e3)),!o.getSession().isRunning){this.isPlayingChar=!1;return}this.feedbackTextEl.textContent="Listen..."}else this.recognizer&&(this.useContinuousMode?this.recognizer.ignoreResults():this.recognizer.stop());const c=await G(r,s.characterSpeed,s.toneFrequency,s.volume);if(!o.getSession().isRunning||!c){this.isPlayingChar=!1;return}this.audioPlayedAt=performance.now(),this.isPlayingChar=!1,this.feedbackTextEl.textContent="Speak the callsign (use phonetics)",this.listeningIndicator.classList.remove("hidden"),this.recognizer&&(this.useContinuousMode?(await new Promise(l=>setTimeout(l,100)),this.audioPlayedAt=performance.now(),this.recognizer.acceptResults()):T()||this.recognizer.start())}handleCallsignRecognitionResult(t,e){const s=o.getSession();if(!s.isRunning||!this.currentCallsign)return;this.recognizer&&(this.recognizer instanceof I&&this.recognizer.setCallsignMode(!1),this.useContinuousMode&&this.recognizer instanceof I?this.recognizer.ignoreResults():this.recognizer.stop()),this.listeningIndicator.classList.add("hidden"),this.hideAcceptButton();const i=e-this.audioPlayedAt,n=Math.max(100,i-tt),r=ne(this.currentCallsign,t),c=r.isCorrect;this.currentCharEl.textContent=this.currentCallsign,this.currentCharEl.className=`current-char ${c?"correct":"incorrect"}`;const l=o.getSettings();if(c?k(l.volume*.6):Q(l.volume*.6),c)this.feedbackTextEl.textContent=`Correct! ${Math.round(n)}ms`,this.debugHeardEl&&(this.debugHeardEl.textContent=`Heard: "${t}" â†’ ${r.parsed} | ${Math.round(n)}ms`,this.debugHeardEl.style.color="#00d26a");else{this.repeatAttempts++;const A=l.maxRepeatTries,C=A<6&&this.repeatAttempts>=A,f=re(r);l.repeatUntilCorrect&&!C?(this.feedbackTextEl.textContent=`Incorrect - ${f}`,this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char incorrect"):C?this.feedbackTextEl.textContent=`Max tries reached - was "${this.currentCallsign}"`:this.feedbackTextEl.textContent=`${f} - was "${this.currentCallsign}"`,this.debugHeardEl&&(this.debugHeardEl.textContent=`Heard: "${t}" â†’ ${r.parsed||"(nothing)"}`,this.debugHeardEl.style.color="#ff4757")}const h=this.currentCallsign.split(""),d={};for(const A of h){const C=o.getCallsignCharacterHistory(A);d[A]={wma:C.wma,mostRecent:C.mostRecent}}this.lastAttempt={type:"callsign",value:this.currentCallsign,chars:h,wasCorrect:c,previousWMAs:d};const u=n/this.currentCallsign.length;for(const A of this.currentCallsign){const C=o.getCallsignCharacterHistory(A),f=b(C.wma,u,c);o.updateCallsignCharacterHistory(A,{wma:f,mostRecent:c?u:z(C.wma),totalAttempts:C.totalAttempts+1,correctAttempts:C.correctAttempts+(c?1:0),lastPracticed:Date.now()})}o.updateSession({totalCharsThisSession:s.totalCharsThisSession+1}),this.nextCharTimeout&&clearTimeout(this.nextCharTimeout);const g=l.maxRepeatTries;!c&&l.repeatUntilCorrect&&(g>=6||this.repeatAttempts<g)?this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,o.getSession().isRunning&&this.replayCurrentCallsign()},At):c?this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,o.getSession().isRunning&&this.playNextCharacter()},B):this.nextCharTimeout=window.setTimeout(()=>{this.nextCharTimeout=null,o.getSession().isRunning&&this.playNextCharacter()},At)}async replayCurrentCallsign(){if(!o.getSession().isRunning||!this.currentCallsign||this.isPlayingChar)return;this.isPlayingChar=!0;const e=o.getSettings();if(this.currentCharEl.textContent="â€”",this.currentCharEl.className="current-char",this.feedbackTextEl.textContent="Listen...",this.listeningIndicator.classList.add("hidden"),this.recognizer&&(this.recognizer.setExpectedChar(null),this.recognizer instanceof I&&this.recognizer.setCallsignMode(!0,this.currentCallsign.length)),T()&&!this.useContinuousMode&&this.recognizer){if(console.log("Android: starting recognition before morse callsign replay (chime will play)"),this.recognizer.start(),this.feedbackTextEl.textContent="Starting...",await new Promise(i=>setTimeout(i,2e3)),!o.getSession().isRunning){this.isPlayingChar=!1;return}this.feedbackTextEl.textContent="Listen..."}else this.recognizer&&(this.useContinuousMode?this.recognizer.ignoreResults():this.recognizer.stop());const s=await G(this.currentCallsign,e.characterSpeed,e.toneFrequency,e.volume);if(!o.getSession().isRunning||!s){this.isPlayingChar=!1;return}this.audioPlayedAt=performance.now(),this.isPlayingChar=!1,this.feedbackTextEl.textContent="Speak the callsign (use phonetics)",this.listeningIndicator.classList.remove("hidden"),this.recognizer&&(this.useContinuousMode?(await new Promise(i=>setTimeout(i,100)),this.audioPlayedAt=performance.now(),this.recognizer.acceptResults()):T()||this.recognizer.start())}checkBreakReminder(){const t=o.getSession();if(!t.isRunning)return;Date.now()-t.lastBreakReminder>=oe&&this.breakModal.classList.remove("hidden")}}async function le(){if(navigator.permissions?.query)try{return(await navigator.permissions.query({name:"microphone"})).state}catch{}return"prompt"}async function he(){try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),!0}catch{return!1}}function St(){const a=/Safari/.test(navigator.userAgent)&&$(),t=/Chrome/.test(navigator.userAgent)&&/Mobile/.test(navigator.userAgent);return a?"Go to Settings â†’ Safari â†’ Microphone and enable access for this site.":t?"Tap the lock icon in the address bar â†’ Site settings â†’ Microphone â†’ Allow.":"Click the lock/info icon in your browser's address bar and allow microphone access, then refresh."}function Lt(){if(T()){console.log("Android detected - showing unsupported banner");const a=document.getElementById("android-banner"),t=document.getElementById("mic-test-area"),e=document.getElementById("practice-area"),s=document.getElementById("chart-section");return a&&a.classList.remove("hidden"),t&&t.classList.add("hidden"),e&&e.classList.add("hidden"),s&&s.classList.add("hidden"),!0}return!1}function Ct(){if(console.log("Morse ICR Trainer initializing..."),Lt()){console.log("Android device - app disabled");return}if(et()){console.log("Mobile detected - using continuous speech recognition mode");const c=document.getElementById("mic-test-area");c&&(c.style.display="none")}y()||console.warn("Speech recognition not supported in this browser"),et()||new Kt;const a=new bt("progress-chart"),t=new jt,e=new ce,s=document.getElementById("char-chart-btn"),i=document.getElementById("word-chart-btn"),n=document.getElementById("callsign-chart-btn"),r=c=>{s?.classList.remove("active"),i?.classList.remove("active"),n?.classList.remove("active"),c==="word"?(i?.classList.add("active"),a.setDataSource("word")):c==="callsign"?(n?.classList.add("active"),a.setDataSource("callsign")):(s?.classList.add("active"),a.setDataSource("individual"))};s?.addEventListener("click",()=>r("character")),i?.addEventListener("click",()=>r("word")),n?.addEventListener("click",()=>r("callsign")),t.setOnModeChange(()=>{e.stop()}),t.setOnChartToggle(c=>{r(c)}),new Yt,console.log("Morse ICR Trainer ready!")}async function de(){if(Lt()){console.log("Android device - skipping permission check");return}const a=document.getElementById("permission-gate"),t=document.getElementById("grant-permission-btn"),e=document.getElementById("permission-error"),s=await le();if(s==="granted"){Ct();return}a.classList.remove("hidden"),s==="denied"&&(e.innerHTML=`<span class="error">Microphone access was denied.</span><br><small>${St()}</small>`,e.classList.remove("hidden")),t.addEventListener("click",async()=>{t.disabled=!0,t.textContent="Requesting...",await he()?(a.classList.add("hidden"),Ct()):(t.disabled=!1,t.textContent="Enable Microphone",e.innerHTML=`<span class="error">Microphone access was denied.</span><br><small>${St()}</small>`,e.classList.remove("hidden"))})}document.addEventListener("DOMContentLoaded",()=>{de()});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").catch(a=>{console.log("Service worker registration failed:",a)})});
//# sourceMappingURL=index-D1m0JKHZ.js.map
