# Vail Training Tools - Project Guide

## Project Overview

**Vail Training Tools** is a web-based Morse code training application designed to help amateur radio operators and Morse code enthusiasts practice receiving and sending Morse code. Currently in BETA, the application is deployed at https://training.vailmorse.com.

The project now includes three training modules:
1. **Copy Practice** - Basic Morse code receiving practice
2. **Send Practice** (Planned) - Morse code sending practice
3. **QSO Simulator** - Advanced pileup training for contesting and field operations

**Status:** BETA - Copy practice fully functional, QSO Simulator integrated with USB CW key support, Send practice planned
**Contact:** ke9bos@pigletradio.org
**Community:** https://discord.gg/GBzj8cBat7

## Technology Stack

### Main Training Tools (Copy/Send Practice)
- **Pure HTML5/CSS3/JavaScript (ES6+)** - No frameworks or build tools
- **Bulma CSS Framework (v0.9.3)** - For responsive layout and components
- **Material Design Icons (v6.5.95)** - Icon library
- **Web Audio API** - For precise Morse code tone generation
- **No build process** - Static files deployable anywhere

### QSO Simulator Module
- **HTML5/CSS3/JavaScript (ES6+)** with Webpack build system
- **Bootstrap 5** with Bootswatch Darkly theme + custom Vail colors
- **FontAwesome Icons (v6.7.1)** - Icon library
- **Web Audio API** - For complex multi-tone generation with QSB/QRN effects
- **Webpack** - Module bundler and build tool
- **npm** - Package management

### Architecture
- **Event-driven architecture** with state-based UI management
- **Web Audio API** for accurate timing and tone generation
- **Hybrid approach:** Main training tools are pure static; QSO Simulator uses modern build pipeline

## Project Structure

```
Vail Training Tools/
├── .claude/                     # Claude configuration
│   └── settings.local.json
├── training/                    # Main application directory
│   ├── assets/                  # Reserved for future assets (currently empty)
│   ├── qso-simulator/           # QSO Simulator module (formerly Morse Walker)
│   │   ├── src/                 # Source files
│   │   │   ├── js/              # JavaScript modules
│   │   │   │   ├── app.js       # Main application entry point
│   │   │   │   ├── audio.js     # Audio engine with QSB/QRN effects
│   │   │   │   ├── inputs.js    # Input validation and handling
│   │   │   │   ├── modes.js     # Training mode configurations
│   │   │   │   ├── stationGenerator.js  # Station generation logic
│   │   │   │   ├── util.js      # Utility functions
│   │   │   │   └── morse-input/ # USB CW key support (NEW)
│   │   │   │       ├── keyer.js    # Multi-mode keyer logic (256 lines)
│   │   │   │       ├── decoder.js  # Dit/dah to character (148 lines)
│   │   │   │       ├── sounder.js  # Audio sidetone (112 lines)
│   │   │   │       └── morse-input.js  # System coordinator (113 lines)
│   │   │   ├── css/
│   │   │   │   └── style.css    # Custom Vail dark theme overrides
│   │   │   ├── audio/           # Audio assets (static noise)
│   │   │   ├── img/             # Images and icons
│   │   │   ├── index.html       # Main QSO Simulator page
│   │   │   └── 404.html         # Error page
│   │   ├── dist/                # Built/compiled files (generated by webpack)
│   │   ├── node_modules/        # npm dependencies
│   │   ├── package.json         # Node.js dependencies and scripts
│   │   ├── webpack.config.*.js  # Webpack build configurations
│   │   └── jsdoc.json           # JSDoc configuration
│   ├── scripts/
│   │   └── training.js          # Core Copy/Send practice logic (618 lines)
│   ├── index.html               # Main landing page with module switcher
│   └── training.css             # Dark theme styles for main tools (576 lines)
├── netlify-deploy/              # Production deployment package
│   ├── index.html               # Main landing page
│   ├── training.css             # Site styles
│   ├── assets/                  # Shared resources
│   ├── scripts/                 # Shared JavaScript
│   └── qso-simulator/           # Built QSO Simulator with USB CW support
└── .claude.md                   # This file
```

## Key Files

### [training/index.html](training/index.html)
- Main application page with semantic HTML5 structure
- Two practice modules: Copy Practice (active) and Send Practice (coming soon)
- Copy practice modes: All Letters, All Numbers, Letters & Numbers, Custom Selection, Common Words, Callsigns, Q Codes
- Settings controls for volume, tone frequency, and reset
- Statistics panel for tracking performance
- Bulma CSS components for responsive layout

### [training/scripts/training.js](training/scripts/training.js)
- **Audio System:** Web Audio API implementation with precise timing
- **Morse Code Data:** Complete morse code mappings, word lists, callsign generator, Q codes
- **Practice Logic:** Random generation, answer checking, statistics tracking
- **Timing Standard:** PARIS timing (50 dit units per minute at 1 WPM)
  - Dit duration = 1200 / WPM milliseconds
  - Dah duration = 3 × dit
  - Element gap = 1 × dit (between dits/dahs within letter)
  - Letter gap = 3 × dit (between letters)
  - Word gap = 7 × dit (between words)
- **Audio Engineering:** 5ms attack/release envelope to prevent clicks

### [training/training.css](training/training.css)
- Custom dark theme optimized for extended practice sessions
- Color palette: #0a0a0a (background), #1a1a1a (boxes), #00d1b2 (accent)
- Smooth animations and transitions (0.2-0.3s ease)
- Responsive breakpoints at 768px for mobile
- Component-based styling approach

## Core Features

### Copy Practice (Implemented)
1. **Practice Modes:**
   - All Letters (A-Z)
   - All Numbers (0-9)
   - Letters & Numbers
   - Custom Selection (pick specific characters)
   - Common Words (100+ words including ham radio terms)
   - Callsigns (realistic US amateur radio callsigns)
   - Q Codes (20 common amateur radio Q codes)

2. **Settings:**
   - Speed: 5-40 WPM
   - Volume: 0-100%
   - Tone Frequency: 400-1000 Hz (default 600 Hz)

3. **Session Statistics:**
   - Total attempts
   - Correct answers
   - Accuracy percentage
   - Current speed display

### Send Practice (Planned)
- Keyboard-based sending practice
- Visual feedback for key down/up
- CW key adapter support (https://www.vailadapter.com)
- Timing analysis and feedback

### QSO Simulator (Implemented)
A sophisticated pileup training simulator for practicing contest-style and field activation QSOs. Based on the Morse Walker project by W6NYC, heavily customized with Vail branding and color scheme.

**Training Modes:**
1. **Single Caller** - Practice basic QSOs with one station at a time
2. **Basic Contest** - Handle multiple stations calling simultaneously
3. **POTA Activator** - Simulate Parks on the Air activation scenarios
4. **CW Ops Test (CWT)** - Practice CWT-style exchanges
5. **K1USN SST** - Simulate SST contest format

**USB CW Key Support (NEW - Added November 2025):**
- **Real-time Morse Input:** Use keyboard or USB CW keys to send morse code
- **Key Mappings:**
  - **Left Control** = Dit (primary)
  - **Right Control** = Dah (primary)
  - **`[` key** = Dit (backup for USB interfaces like vband)
  - **`]` key** = Dah (backup for USB interfaces)
- **Multiple Keyer Modes:**
  - **Mode 1: Straight Key** - Direct on/off control
  - **Mode 2: Iambic A** - Automatic alternation between dit and dah
  - **Mode 3: Iambic B** - Enhanced with queue retention for smoother keying
  - **Mode 4: Ultimatic** - Lever-priority keying mode
- **Real-time Decoder:**
  - Automatically converts dit/dah timing into characters
  - Adaptive speed adjustment based on your actual keying speed
  - Inserts decoded characters directly into input fields
  - Supports Farnsworth timing configuration
- **Audio Sidetone:**
  - Configurable sidetone frequency (matches "Your Sidetone" setting)
  - Configurable volume (matches "Sidetone Volume" setting)
  - 5ms attack/release envelope for smooth, click-free tones
  - Uses shared AudioContext with main application
- **Morse Input Modules:**
  - `keyer.js` - Multi-mode keyer implementation with WPM-based timing
  - `decoder.js` - Dit/dah sequence to character conversion with adaptive timing
  - `sounder.js` - Audio sidetone generation using Web Audio API
  - `morse-input.js` - System coordinator and MorseWalker integration
- **Integration:**
  - Initializes automatically when CQ button is clicked
  - Syncs with user settings (WPM, sidetone frequency, Farnsworth spacing)
  - LocalStorage persistence for keyer mode preference
  - Non-intrusive - doesn't interfere with existing typed input method

**Key Features:**
- **Realistic Audio Environment:**
  - Multiple simultaneous CW tones at different frequencies
  - QSB (signal fading) simulation with configurable percentage
  - QRN (atmospheric noise) at various intensity levels (Off, Normal, Moderate, Heavy)
  - Volume normalization prevents audio artifacts

- **Configurable Settings:**
  - Your station: Callsign, name, state, speed (WPM), sidetone frequency/volume, keyer mode
  - Responding stations: Max stations, speed range (min/max WPM), Farnsworth spacing
  - Tone range: 400-9999 Hz (min/max)
  - Volume range: 0-100% (min/max)
  - Wait time: 0-5 seconds between responses
  - Cut numbers support (T/0, A/1, U/2, V/3, E/5, G/7, D/8, N/9) - PRESERVED
  - Callsign format options (1x1, 1x2, 2x1, 2x2, 1x3, 2x3)
  - US-only callsigns option

- **Advanced Interactions:**
  - Partial callsign matching to isolate stations in pileup
  - "AGN" or "?" to request repeats
  - "QRS" to slow down responding stations (adds Farnsworth spacing)
  - Real-time attempts and timing tracking
  - Results table with accuracy feedback
  - USB CW key input for realistic sending practice

- **Development Tools:**
  - Browser console "cheat mode" displays calling station callsigns
  - JSDoc documentation available
  - Webpack build system for optimization
  - Hot module replacement in dev mode
  - Prettier code formatting
  - Husky pre-commit hooks

**Technical Architecture:**
- Modular ES6+ JavaScript with Webpack bundling
- Shared AudioContext with individual OscillatorNode instances per station
- GainNode for QSB simulation with depth, frequency, and phase randomization
- Mode-based configuration system for different contest formats
- LocalStorage for settings persistence
- Bootstrap 5 + custom Vail dark theme CSS
- Morse input system with event-driven keyer/decoder architecture

**File Locations:**
- Main source: [training/qso-simulator/src/](training/qso-simulator/src/)
- Morse input: [training/qso-simulator/src/js/morse-input/](training/qso-simulator/src/js/morse-input/)
- Build output: [training/qso-simulator/dist/](training/qso-simulator/dist/)
- Entry point: [training/qso-simulator/src/js/app.js](training/qso-simulator/src/js/app.js)
- Theme customization: [training/qso-simulator/src/css/style.css](training/qso-simulator/src/css/style.css)

**Build Commands:**
```bash
cd training/qso-simulator
npm install          # Install dependencies
npm start           # Development server with hot reload
npm run build       # Production build to dist/
npm run format      # Format code with Prettier
```

**Vail Customizations:**
- Rebranded from "Morse Walker" to "Vail QSO Simulator"
- Changed tagline from "Walk before you run!" to "Master the pileup!"
- Applied Vail dark theme colors (turquoise #00d1b2 accent on dark backgrounds)
- Updated all links to point to vailmorse.com, Discord, and KE9BOS contact
- Maintained credit to original author W6NYC in footer
- Switched from Cerulean to Darkly Bootstrap theme with CSS overrides
- Added USB CW key support while preserving all original features (especially cut numbers)

## Development Guidelines

### Code Style & Conventions
- **JavaScript:** camelCase for variables/functions, descriptive names
- **Constants:** Organized in object literals (morseCode, commonWords, etc.)
- **Event Handling:** Event-driven with DOMContentLoaded initialization
- **State Management:** Simple object-based state tracking
- **Error Handling:** Console logging for debugging, try-catch for critical operations

### Naming Patterns
- Functions: `playTone()`, `generateCallsign()`, `checkAnswer()`
- State variables: `isPracticing`, `currentAnswer`, `isPlaying`
- UI elements: descriptive IDs matching their purpose (e.g., `copyModeSelect`, `checkAnswerBtn`)

### CSS Architecture
- Component-based class naming: `.practice-box`, `.stats-box`, `.settings-dropdown`
- Dark theme first with consistent color variables
- Smooth transitions and animations throughout
- Mobile-first responsive design

### Audio Implementation Details
- **Click Prevention:** 5ms attack/release envelope on all tones
- **Volume Safety:** Max gain clamped to 0.3 (30%) to prevent clipping
- **Precise Timing:** Web Audio API currentTime for scheduling accuracy
- **State Guards:** isPlaying flag prevents audio overlap
- **Shared Context:** All audio components use a single AudioContext for efficiency

### Amateur Radio Realism
- **Callsign Generator:**
  - 70% single-letter prefix (W, K, N, A)
  - 30% two-letter prefix (AA-AL, KA-KZ, NA-NZ, WA-WZ)
  - Weighted suffix lengths: 20% one letter, 40% two letters, 40% three letters
- **Q Codes:** 20 most common codes (QRL, QRM, QRN, QRO, QRP, QRS, QRT, QRZ, QSB, QSL, QSO, QSY, QTH, QRQ, QRV, QRX, QRK, QSK, QTC, QRU)
- **Common Words:** Mix of general English and ham radio terminology

## Development Workflow

### Local Development - Main Training Tools
1. Open [training/index.html](training/index.html) in a modern web browser
2. Make changes to HTML, CSS, or JS files
3. Refresh browser to see changes (no build step required)
4. Use browser DevTools console for debugging (extensive console.log statements in code)

### Local Development - QSO Simulator
1. Navigate to qso-simulator directory: `cd training/qso-simulator`
2. Install dependencies (first time only): `npm install`
3. Start development server: `npm start` (opens browser automatically at http://localhost:8080)
4. Make changes to files in `src/` directory
5. Webpack dev server auto-reloads on file changes
6. Build for production: `npm run build` (outputs to `dist/` directory)

### Testing Approach
- **Manual testing** in browser (no automated tests currently)
- Test across different browsers (Chrome, Firefox, Safari, Edge)
- Verify audio playback and timing accuracy
- Test responsive design at various screen sizes
- Verify all practice modes generate appropriate content
- **QSO Simulator:** Test multiple simultaneous audio streams and QSB/QRN effects
- **USB CW Key Testing:**
  - Test Left/Right Control keys for dit/dah input
  - Test bracket keys `[` and `]` as backup inputs
  - Verify all 4 keyer modes (straight, iambic A, iambic B, ultimatic)
  - Test decoder accuracy at various speeds (5-40 WPM)
  - Verify sidetone audio and volume control
  - Test Farnsworth timing integration

### Deployment
- **Deployment Package Location:** `netlify-deploy/` folder in project root
- **Build Process:**
  1. Navigate to qso-simulator: `cd training/qso-simulator`
  2. Run production build: `npm run build`
  3. Update netlify-deploy folder: Handled automatically by build process
- **Deployment Steps:**
  1. Drag entire `netlify-deploy/` folder to Netlify dashboard
  2. Or use CLI: `netlify deploy --prod --dir=netlify-deploy`
- **Currently deployed at:** https://training.vailmorse.com
- **What's Included:**
  - Main landing page and training tools (static files)
  - QSO Simulator with USB CW key support (built and bundled)
  - All assets, images, and resources

## Technical Highlights

### Web Audio API Implementation
```javascript
// Initialize audio context
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// Create oscillator and gain nodes
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();

// Precise timing using scheduled automation
gainNode.gain.setValueAtTime(0, startTime);
gainNode.gain.linearRampToValueAtTime(volume, startTime + attackTime);
gainNode.gain.setValueAtTime(volume, endTime - releaseTime);
gainNode.gain.linearRampToValueAtTime(0, endTime);
```

### PARIS Timing Standard
The application uses the PARIS standard for Morse code timing:
- 1 WPM = 50 dit units per minute (word "PARIS" = 50 dits)
- At 1 WPM, one dit = 1.2 seconds (1200 milliseconds)
- At N WPM, one dit = 1200 / N milliseconds

### USB CW Key Architecture
```javascript
// Keyer captures keyboard events
document.addEventListener('keydown', (event) => {
  keyer.press(event, true);  // Key down
});

document.addEventListener('keyup', (event) => {
  keyer.press(event, false); // Key up
});

// Decoder measures timing and converts to characters
decoder.keyOn();  // Start timing
decoder.keyOff(); // Calculate dit/dah and decode

// Sounder provides audio feedback
sounder.on();  // Smooth attack
sounder.off(); // Smooth release
```

### State Management Pattern
```javascript
const state = {
    isPracticing: false,
    currentAnswer: '',
    stats: { total: 0, correct: 0 }
};

// UI reflects state through enable/disable patterns
function updateUI() {
    startBtn.disabled = isPracticing;
    stopBtn.disabled = !isPracticing;
    checkAnswerBtn.disabled = !isPracticing;
}
```

## Known Limitations & Future Work

### Current Limitations
- No settings persistence for main training tools (localStorage not implemented)
- No progress tracking over time
- No automated testing
- Limited accessibility features
- Magic numbers throughout code (could be constants)
- No error handling for audio context initialization failures

### Planned Features (TODOs)
1. **Send Practice Module** ([training/scripts/training.js:558](training/scripts/training.js#L558), [training/scripts/training.js:563](training/scripts/training.js#L563))
   - Key down/up visual feedback
   - Keyboard shortcuts implementation (`.`, `/`, `x`, `z` keys)
   - CW key adapter support
   - Timing analysis and feedback

2. **Settings Persistence**
   - Save user preferences to localStorage
   - Restore settings on page load

3. **Progress Tracking**
   - Track performance over multiple sessions
   - Show improvement trends
   - Export practice logs

4. **Enhanced Accessibility**
   - More ARIA labels
   - Keyboard navigation improvements
   - Screen reader optimization

## External Resources

### CDN Dependencies
- Bulma CSS v0.9.3: https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css
- Material Design Icons v6.5.95: https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css

### Related Links
- Main Vail Morse Repeater: http://vailmorse.com
- CW Adapter Product: https://www.vailadapter.com
- Discord Community: https://discord.gg/GBzj8cBat7

## Common Tasks

### Adding a New Practice Mode
1. Add mode to [training/index.html](training/index.html) `copyModeSelect` dropdown
2. Implement generation logic in [training/scripts/training.js](training/scripts/training.js) `startCopyPractice()` function
3. Test with various WPM settings

### Adjusting Timing Parameters
Edit constants in [training/scripts/training.js](training/scripts/training.js) `getTimingFromWPM()` function:
- `ditTime`: Base unit for all timing (1200 / wpm)
- `dahTime`: 3× dit time
- `elementGap`: 1× dit time (between dits/dahs)
- `letterGap`: 3× dit time (between letters)
- `wordGap`: 7× dit time (between words)

### Modifying Color Scheme
Edit CSS custom properties in [training/training.css](training/training.css):
- Background: `#0a0a0a`
- Box background: `#1a1a1a`
- Text: `#e8e8e8`
- Accent: `#00d1b2` (Bulma turquoise)
- Borders: `#2a2a2a`

### Adding New Words or Q Codes
Edit arrays in [training/scripts/training.js](training/scripts/training.js):
- `commonWords`: Array of practice words (line ~30-130)
- `qCodes`: Array of Q code objects with code and description (line ~135-160)

### Modifying USB CW Key Mappings
Edit keyer initialization in [training/qso-simulator/src/js/morse-input/keyer.js](training/qso-simulator/src/js/morse-input/keyer.js):
- `ditKey1`: Primary dit key (currently 'ControlLeft')
- `dahKey1`: Primary dah key (currently 'ControlRight')
- `ditKey2`: Backup dit key (currently 'BracketLeft')
- `dahKey2`: Backup dah key (currently 'BracketRight')

## Debugging Tips

### Audio Issues
1. Check browser console for Web Audio API errors
2. Verify `audioContext.state === 'running'`
3. Test with different tone frequencies (400-1000 Hz range)
4. Check volume is not set to 0

### Timing Issues
1. Console logs show timing calculations in `playMorseSequence()`
2. Verify WPM setting is within 5-40 range
3. Check that `getTimingFromWPM()` returns expected values

### USB CW Key Issues
1. Check browser console for keyboard event logging
2. Verify keyer mode is set correctly (1-4)
3. Test with both Control keys and bracket keys
4. Check sidetone volume is not set to 0
5. Ensure morse input is initialized (click CQ button first)
6. Verify decoder timing thresholds match expected WPM

### UI State Issues
1. Check `isPracticing` flag state
2. Verify event listeners are properly attached
3. Use browser DevTools to inspect button disabled states

## Best Practices

### When Modifying Code
- Maintain consistent indentation (2 spaces)
- Add console.log statements for debugging
- Test audio timing with metronome/reference
- Verify mobile responsiveness after UI changes
- Keep dark theme consistent across new components

### When Adding Features
- Follow existing event-driven patterns
- Use descriptive variable and function names
- Add comments for complex timing or audio logic
- Test across multiple browsers
- Consider mobile users (touch interactions, screen size)

### Code Organization
- Keep related functionality grouped together
- Separate concerns: audio, UI, practice logic
- Use small, focused functions
- Avoid global variables where possible
- Document any non-obvious algorithms

## Contributing Guidelines

### Code Quality
- Write clean, readable code with consistent formatting
- Add comments for complex logic
- Use meaningful variable names
- Keep functions focused and small
- Test thoroughly before committing

### Amateur Radio Standards
- Maintain PARIS timing standard accuracy
- Use realistic callsign patterns
- Include appropriate Q codes and abbreviations
- Follow amateur radio conventions

### User Experience
- Maintain dark theme for eye comfort
- Keep UI simple and uncluttered
- Provide immediate feedback for user actions
- Ensure responsive design works on mobile
- Consider accessibility in all UI changes

---

## Quick Reference

### Key Functions
- `initAudioContext()`: Initialize Web Audio API
- `playTone(frequency, duration, volume)`: Generate sine wave tone
- `playMorseSequence(text, wpm, frequency, volume)`: Play complete Morse sequence
- `getTimingFromWPM(wpm)`: Calculate timing values from WPM
- `generateCallsign()`: Create realistic amateur radio callsign
- `checkAnswer()`: Validate user input and update statistics

### Important Constants
- Default WPM: 20
- Default Tone: 600 Hz
- Default Volume: 50%
- WPM Range: 5-40
- Tone Range: 400-1000 Hz

### File Locations
- Main HTML: [training/index.html](training/index.html)
- Core Logic: [training/scripts/training.js](training/scripts/training.js)
- Styles: [training/training.css](training/training.css)
- QSO Simulator: [training/qso-simulator/](training/qso-simulator/)
- USB CW Key Modules: [training/qso-simulator/src/js/morse-input/](training/qso-simulator/src/js/morse-input/)
- Deployment Package: [netlify-deploy/](netlify-deploy/)

---

## Recent Updates

### November 2, 2025 - USB CW Key Support
- Integrated USB CW key support from morsewalker usb-support branch
- Added 4 morse-input modules: keyer.js, decoder.js, sounder.js, morse-input.js
- Implemented 4 keyer modes: Straight Key, Iambic A, Iambic B, Ultimatic
- Real-time morse decoding with adaptive speed adjustment
- Configurable sidetone audio synchronized with user settings
- Key mappings: Left/Right Control (primary), `[`/`]` brackets (backup)
- **PRESERVED all existing features including cut numbers functionality**
- Updated netlify-deploy package with complete site structure

---

*Last Updated: 2025-11-02*
*Project Status: BETA - Copy Practice Functional, QSO Simulator with USB CW Key Support, Send Practice Planned*
